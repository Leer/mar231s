# plotly {-}

## Запись занятия {-}

<iframe width="560" height="315" src="https://www.youtube.com/embed/S-9kqnPXwI8?si=DE__J6jyarSzvaGh" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>

## Пакеты и данные {-}


```r
library(ggplot2)
library(plotly)
library(data.table)
```



```r
imdb_link <- 'https://gitlab.com/upravitelev/mar201s/raw/master/data/IMDb%20movies.csv'
tg_cols <- c("director", "title", "original_title", "year", 
             "genre", "duration", "country", "avg_vote")
imdb <- fread(imdb_link, select = tg_cols)
imdb[, year := as.numeric(year)]

imdb_woody <- imdb[director == 'Woody Allen']
imdb_martin <- imdb[director == 'Martin Scorsese']
imdb_lynch <- imdb[director == 'David Lynch']

imdb_genres <- imdb[genre %in% c('Horror', 'Comedy', 'Drama')]
imdb_genres_scores <- imdb_genres[, 
                                  list(n_titles = .N, votes = mean(avg_vote)), 
                                  by = list(year, genre)] 
```

## Компоненты графика plotly  {-}
### Данные и оси {-}
Базовая функция для создания интерактивных графиков - `plot_ly()`. Для создания самого простого графика уже достаточно будет указать датасет, оси и тип графика. Оси задаются указанием названий колонок датасета, через оператор формулы (тильда, `~`). Вообще, такая форма используется во всех местах, где идет обращение к колонкам датасета (ховеры, цвета и группировки и проч). В `ggplot2` в какой-то мере аналогом такого обращения к колонкам датасета будет функция `aes()`.


```r
plot_ly(economics,
        x = ~date,
        y = ~uempmed,
        name = "unemployment",
        marker = list(color="#264E86"),
        type = "scatter", mode = "markers")
```



<br>

## Типы графиков {-}
В plotly реализованы базовые графики, в частности, линии, гистограммы и барчарты, боксплоты, тепловые карты, геокарты, а так же некоторые 3d-графики. Создавать собственные типы графиков средствами plotly, к сожалению, нельзя.

Полный список графиков, реализованных в plotly, можно посмотреть на [сайте](https://plot.ly/r/) библиотеки или же на странице [документации](https://plot.ly/r/reference/). 


### Точечный и линейный графики {-}
Тип графиков задается аргументом `type` функции `plot_ly()`. Для некоторых графиков, в частности, для диаграмм рассеяния (точек) и линий используется один `type`, но с разными значениям доп.аргумента `mode`. Например, с помощью `type = 'scatter'` и `mode = 'markers'` задается точечный график. Для того, чтобы был правильный порядок точек и линий, необходимо отсортировать таблицу (в противном случае может получиться клубок линий).

```r
# отсортируем и построим точечный график
imdb_genres_scores <- imdb_genres_scores[order(year, genre)]
plot_ly(imdb_genres_scores[genre == 'Horror'], x = ~year, y = ~votes,
        type = 'scatter', mode = 'markers')
```

```{=html}
<div class="plotly html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-461d837ebcc89dc815d6" style="width:100%;height:480px;"></div>
<script type="application/json" data-for="htmlwidget-461d837ebcc89dc815d6">{"x":{"visdat":{"9544765b74ade":["function () ","plotlyVisDat"]},"cur_data":"9544765b74ade","attrs":{"9544765b74ade":{"x":{},"y":{},"mode":"markers","alpha_stroke":1,"sizes":[10,100],"spans":[1,20],"type":"scatter"}},"layout":{"margin":{"b":40,"l":60,"t":25,"r":10},"xaxis":{"domain":[0,1],"automargin":true,"title":"year"},"yaxis":{"domain":[0,1],"automargin":true,"title":"votes"},"hovermode":"closest","showlegend":false},"source":"A","config":{"modeBarButtonsToAdd":["hoverclosest","hovercompare"],"showSendToCloud":false},"data":[{"x":[1915,1917,1920,1925,1927,1928,1932,1934,1935,1940,1941,1945,1946,1948,1949,1951,1952,1953,1957,1958,1959,1960,1961,1962,1963,1964,1965,1966,1967,1968,1969,1970,1971,1972,1973,1974,1975,1976,1977,1978,1979,1980,1981,1982,1983,1984,1985,1986,1987,1988,1989,1990,1991,1992,1993,1994,1995,1996,1997,1998,1999,2000,2001,2002,2003,2004,2005,2006,2007,2008,2009,2010,2011,2012,2013,2014,2015,2016,2017,2018,2019,2020],"y":[6.7999999999999998,6.0999999999999996,6,7.5999999999999996,6.7999999999999998,7.2999999999999998,6.2999999999999998,3.6500000000000004,7.0999999999999996,4.25,7.2999999999999998,6,4.8666666666666663,4.9499999999999993,7.0999999999999996,4.4000000000000004,5.5999999999999996,7.0999999999999996,5.0700000000000003,5.0499999999999998,5.8999999999999995,5.7222222222222223,5.0666666666666664,5.5444444444444452,5.8076923076923084,5.6352941176470601,4.6600000000000001,5.3769230769230756,5.0250000000000004,5.4699999999999998,4.96,5.0111111111111111,5.1552631578947361,4.8405405405405393,5.3414634146341466,4.8625000000000007,4.6315789473684212,5.1227272727272721,4.9650000000000007,4.9333333333333336,4.7428571428571429,5.0000000000000009,5.3533333333333326,4.8136363636363635,4.6739130434782616,4.3666666666666663,4.4285714285714288,4.3857142857142861,4.6424242424242426,4.418181818181818,4.6525000000000007,4.9208333333333334,4.9117647058823533,4.6533333333333333,4.7066666666666652,4.3599999999999994,4.0333333333333323,4.8181818181818183,4.4153846153846157,4.208333333333333,4.2750000000000004,3.9947368421052634,4.2923076923076922,4.7230769230769232,4.0473684210526315,3.9435897435897433,4.2166666666666668,4.0657142857142858,3.8637681159420283,4.1161290322580637,4.0424242424242438,4.0253521126760576,4.0236111111111104,3.9182926829268285,3.9614583333333346,4.1582524271844665,3.9165137614678875,3.9650485436893192,4.346564885496182,4.3315789473684205,4.1585106382978729,4.0628571428571432],"mode":"markers","type":"scatter","marker":{"color":"rgba(31,119,180,1)","line":{"color":"rgba(31,119,180,1)"}},"error_y":{"color":"rgba(31,119,180,1)"},"error_x":{"color":"rgba(31,119,180,1)"},"line":{"color":"rgba(31,119,180,1)"},"xaxis":"x","yaxis":"y","frame":null}],"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.20000000000000001,"selected":{"opacity":1},"debounce":0},"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot","plotly_sunburstclick"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}</script>
```

Линейный график задается с помощью `type = 'scatter'` и `mode = 'lines'`:

```r
# построим линейный график
plot_ly(imdb_genres_scores[genre == 'Horror'], x = ~year, y = ~votes,
        type = 'scatter', mode = 'lines')
```

```{=html}
<div class="plotly html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-2fb247593f05a02d0e89" style="width:100%;height:480px;"></div>
<script type="application/json" data-for="htmlwidget-2fb247593f05a02d0e89">{"x":{"visdat":{"954473211dc04":["function () ","plotlyVisDat"]},"cur_data":"954473211dc04","attrs":{"954473211dc04":{"x":{},"y":{},"mode":"lines","alpha_stroke":1,"sizes":[10,100],"spans":[1,20],"type":"scatter"}},"layout":{"margin":{"b":40,"l":60,"t":25,"r":10},"xaxis":{"domain":[0,1],"automargin":true,"title":"year"},"yaxis":{"domain":[0,1],"automargin":true,"title":"votes"},"hovermode":"closest","showlegend":false},"source":"A","config":{"modeBarButtonsToAdd":["hoverclosest","hovercompare"],"showSendToCloud":false},"data":[{"x":[1915,1917,1920,1925,1927,1928,1932,1934,1935,1940,1941,1945,1946,1948,1949,1951,1952,1953,1957,1958,1959,1960,1961,1962,1963,1964,1965,1966,1967,1968,1969,1970,1971,1972,1973,1974,1975,1976,1977,1978,1979,1980,1981,1982,1983,1984,1985,1986,1987,1988,1989,1990,1991,1992,1993,1994,1995,1996,1997,1998,1999,2000,2001,2002,2003,2004,2005,2006,2007,2008,2009,2010,2011,2012,2013,2014,2015,2016,2017,2018,2019,2020],"y":[6.7999999999999998,6.0999999999999996,6,7.5999999999999996,6.7999999999999998,7.2999999999999998,6.2999999999999998,3.6500000000000004,7.0999999999999996,4.25,7.2999999999999998,6,4.8666666666666663,4.9499999999999993,7.0999999999999996,4.4000000000000004,5.5999999999999996,7.0999999999999996,5.0700000000000003,5.0499999999999998,5.8999999999999995,5.7222222222222223,5.0666666666666664,5.5444444444444452,5.8076923076923084,5.6352941176470601,4.6600000000000001,5.3769230769230756,5.0250000000000004,5.4699999999999998,4.96,5.0111111111111111,5.1552631578947361,4.8405405405405393,5.3414634146341466,4.8625000000000007,4.6315789473684212,5.1227272727272721,4.9650000000000007,4.9333333333333336,4.7428571428571429,5.0000000000000009,5.3533333333333326,4.8136363636363635,4.6739130434782616,4.3666666666666663,4.4285714285714288,4.3857142857142861,4.6424242424242426,4.418181818181818,4.6525000000000007,4.9208333333333334,4.9117647058823533,4.6533333333333333,4.7066666666666652,4.3599999999999994,4.0333333333333323,4.8181818181818183,4.4153846153846157,4.208333333333333,4.2750000000000004,3.9947368421052634,4.2923076923076922,4.7230769230769232,4.0473684210526315,3.9435897435897433,4.2166666666666668,4.0657142857142858,3.8637681159420283,4.1161290322580637,4.0424242424242438,4.0253521126760576,4.0236111111111104,3.9182926829268285,3.9614583333333346,4.1582524271844665,3.9165137614678875,3.9650485436893192,4.346564885496182,4.3315789473684205,4.1585106382978729,4.0628571428571432],"mode":"lines","type":"scatter","marker":{"color":"rgba(31,119,180,1)","line":{"color":"rgba(31,119,180,1)"}},"error_y":{"color":"rgba(31,119,180,1)"},"error_x":{"color":"rgba(31,119,180,1)"},"line":{"color":"rgba(31,119,180,1)"},"xaxis":"x","yaxis":"y","frame":null}],"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.20000000000000001,"selected":{"opacity":1},"debounce":0},"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot","plotly_sunburstclick"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}</script>
```

### Столбиковые диаграммы {-}
Для отрисовки столбиковых диаграмм используется параметр `type = 'bar'`. Естественно, данные должны быть соответствующей структуры. Например, посчитаем количество фильмов каждого жанра в год и отрисуем столбиками (датасет подготовили ранее):

```r
plot_ly(imdb_genres_scores[year > 2010 & genre == 'Drama'], 
        x = ~year, y = ~n_titles, type = 'bar')
```

```{=html}
<div class="plotly html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-04585aaf3fd971dac4ed" style="width:100%;height:480px;"></div>
<script type="application/json" data-for="htmlwidget-04585aaf3fd971dac4ed">{"x":{"visdat":{"954477f00201b":["function () ","plotlyVisDat"]},"cur_data":"954477f00201b","attrs":{"954477f00201b":{"x":{},"y":{},"alpha_stroke":1,"sizes":[10,100],"spans":[1,20],"type":"bar"}},"layout":{"margin":{"b":40,"l":60,"t":25,"r":10},"xaxis":{"domain":[0,1],"automargin":true,"title":"year"},"yaxis":{"domain":[0,1],"automargin":true,"title":"n_titles"},"hovermode":"closest","showlegend":false},"source":"A","config":{"modeBarButtonsToAdd":["hoverclosest","hovercompare"],"showSendToCloud":false},"data":[{"x":[2011,2012,2013,2014,2015,2016,2017,2018,2019,2020],"y":[416,441,399,412,430,447,531,518,461,104],"type":"bar","marker":{"color":"rgba(31,119,180,1)","line":{"color":"rgba(31,119,180,1)"}},"error_y":{"color":"rgba(31,119,180,1)"},"error_x":{"color":"rgba(31,119,180,1)"},"xaxis":"x","yaxis":"y","frame":null}],"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.20000000000000001,"selected":{"opacity":1},"debounce":0},"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot","plotly_sunburstclick"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}</script>
```


### Боксплоты {-}
Поведение точно такое же, как для типа `type = 'bar'` - по оси y выставляем переменную, по которой хотим увидеть боксплот, а в типе пишем `type = 'box'`:

```r
plot_ly(imdb_genres_scores, x = ~genre, y = ~votes, type = 'box')
```

```{=html}
<div class="plotly html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-6140a06da9a3a3507066" style="width:100%;height:480px;"></div>
<script type="application/json" data-for="htmlwidget-6140a06da9a3a3507066">{"x":{"visdat":{"954477038e80c":["function () ","plotlyVisDat"]},"cur_data":"954477038e80c","attrs":{"954477038e80c":{"x":{},"y":{},"alpha_stroke":1,"sizes":[10,100],"spans":[1,20],"type":"box"}},"layout":{"margin":{"b":40,"l":60,"t":25,"r":10},"xaxis":{"domain":[0,1],"automargin":true,"title":"genre","type":"category","categoryorder":"array","categoryarray":["Comedy","Drama","Horror"]},"yaxis":{"domain":[0,1],"automargin":true,"title":"votes"},"hovermode":"closest","showlegend":false},"source":"A","config":{"modeBarButtonsToAdd":["hoverclosest","hovercompare"],"showSendToCloud":false},"data":[{"fillcolor":"rgba(31,119,180,0.5)","x":["Drama","Drama","Drama","Comedy","Drama","Comedy","Drama","Horror","Comedy","Drama","Comedy","Drama","Horror","Comedy","Drama","Comedy","Drama","Comedy","Drama","Horror","Comedy","Drama","Drama","Comedy","Drama","Comedy","Drama","Comedy","Drama","Horror","Comedy","Drama","Comedy","Drama","Horror","Comedy","Drama","Horror","Comedy","Drama","Comedy","Drama","Comedy","Drama","Comedy","Drama","Horror","Comedy","Drama","Comedy","Drama","Horror","Comedy","Drama","Horror","Comedy","Drama","Comedy","Drama","Comedy","Drama","Comedy","Drama","Comedy","Drama","Horror","Comedy","Drama","Horror","Comedy","Drama","Comedy","Drama","Comedy","Drama","Comedy","Drama","Horror","Comedy","Drama","Horror","Comedy","Drama","Comedy","Drama","Horror","Comedy","Drama","Horror","Comedy","Drama","Comedy","Drama","Horror","Comedy","Drama","Horror","Comedy","Drama","Horror","Comedy","Drama","Comedy","Drama","Comedy","Drama","Comedy","Drama","Horror","Comedy","Drama","Horror","Comedy","Drama","Horror","Comedy","Drama","Horror","Comedy","Drama","Horror","Comedy","Drama","Horror","Comedy","Drama","Horror","Comedy","Drama","Horror","Comedy","Drama","Horror","Comedy","Drama","Horror","Comedy","Drama","Horror","Comedy","Drama","Horror","Comedy","Drama","Horror","Comedy","Drama","Horror","Comedy","Drama","Horror","Comedy","Drama","Horror","Comedy","Drama","Horror","Comedy","Drama","Horror","Comedy","Drama","Horror","Comedy","Drama","Horror","Comedy","Drama","Horror","Comedy","Drama","Horror","Comedy","Drama","Horror","Comedy","Drama","Horror","Comedy","Drama","Horror","Comedy","Drama","Horror","Comedy","Drama","Horror","Comedy","Drama","Horror","Comedy","Drama","Horror","Comedy","Drama","Horror","Comedy","Drama","Horror","Comedy","Drama","Horror","Comedy","Drama","Horror","Comedy","Drama","Horror","Comedy","Drama","Horror","Comedy","Drama","Horror","Comedy","Drama","Horror","Comedy","Drama","Horror","Comedy","Drama","Horror","Comedy","Drama","Horror","Comedy","Drama","Horror","Comedy","Drama","Horror","Comedy","Drama","Horror","Comedy","Drama","Horror","Comedy","Drama","Horror","Comedy","Drama","Horror","Comedy","Drama","Horror","Comedy","Drama","Horror","Comedy","Drama","Horror","Comedy","Drama","Horror","Comedy","Drama","Horror","Comedy","Drama","Horror","Comedy","Drama","Horror","Comedy","Drama","Horror","Comedy","Drama","Horror","Comedy","Drama","Horror","Comedy","Drama","Horror","Comedy","Drama","Horror","Comedy","Drama","Horror","Comedy","Drama","Horror","Comedy","Drama","Horror","Comedy","Drama","Horror","Comedy","Drama","Horror","Comedy","Drama","Horror"],"y":[5.7999999999999998,5.5,6.7666666666666657,6.0499999999999998,5.9000000000000004,5.9000000000000004,6.327272727272728,6.7999999999999998,5.75,6.2999999999999998,5.7749999999999995,6.5800000000000001,6.0999999999999996,6.2999999999999998,6.1888888888888891,6.416666666666667,6.1600000000000001,6.3999999999999995,6.1166666666666671,6,6.8250000000000011,6.5764705882352947,6.4400000000000004,7.25,6.6624999999999996,6.3285714285714292,6.6454545454545464,6.4857142857142858,6.5294117647058814,7.5999999999999996,6.5875000000000004,6.8928571428571432,6.2000000000000002,6.1999999999999993,6.7999999999999998,6.4250000000000007,6.4944444444444445,7.2999999999999998,6.0999999999999996,6.6099999999999994,6.3500000000000005,6.477777777777777,6.4857142857142858,6.2999999999999998,6.333333333333333,6.4857142857142875,6.2999999999999998,6.4272727272727277,6.4951219512195122,6.5352941176470596,6.4840909090909102,3.6500000000000004,6.6461538461538456,6.5303030303030303,7.0999999999999996,6.5136363636363654,6.6250000000000018,6.479166666666667,6.5124999999999993,6.5909090909090926,6.1842105263157894,6.9875000000000007,6.5068965517241368,6.496428571428571,6.4359999999999991,4.25,6.5900000000000007,6.6000000000000005,7.2999999999999998,6.5,6.3888888888888893,6.3058823529411763,6.8285714285714283,6.4058823529411768,6.5600000000000005,6.371428571428571,6.4874999999999989,6,6.4124999999999996,6.681481481481482,4.8666666666666663,6.490909090909093,6.6999999999999993,6.4722222222222205,6.8723404255319176,4.9499999999999993,6.3954545454545446,6.8878787878787877,7.0999999999999996,6.2777777777777768,6.8000000000000007,6.4279999999999982,6.8500000000000005,4.4000000000000004,6.3883720930232553,6.9222222222222207,5.5999999999999996,6.5296296296296292,6.7612903225806447,7.0999999999999996,6.3382352941176459,6.7605263157894742,6.4309523809523785,6.7749999999999995,6.3699999999999992,6.9298245614035086,6.3772727272727279,6.6755555555555555,5.0700000000000003,6.4604166666666663,6.9265306122448962,5.0499999999999998,6.3660000000000005,6.7581818181818178,5.8999999999999995,6.2740000000000009,6.6555555555555577,5.7222222222222223,6.2566037735849074,6.6826666666666679,5.0666666666666664,6.2775510204081639,6.8536231884057992,5.5444444444444452,6.4338983050847469,6.9305555555555545,5.8076923076923084,6.227586206896552,6.9220338983050835,5.6352941176470601,6.2927272727272738,6.7333333333333343,4.6600000000000001,6.0586956521739141,6.758208955223882,5.3769230769230756,6.2553571428571413,6.7203125000000012,5.0250000000000004,6.1732142857142867,6.5038461538461556,5.4699999999999998,5.8624999999999989,6.5825581395348811,4.96,5.8910447761194034,6.4813725490196088,5.0111111111111111,5.7116883116883095,6.486516853932585,5.1552631578947361,5.7919354838709669,6.6492957746478867,4.8405405405405393,5.8015873015873005,6.4818181818181815,5.3414634146341466,5.7900000000000009,6.4625000000000012,4.8625000000000007,5.8761904761904749,6.5553846153846154,4.6315789473684212,5.9173333333333327,6.4411764705882337,5.1227272727272721,5.7446428571428587,6.7127906976744205,4.9650000000000007,5.9388888888888909,6.5341463414634156,4.9333333333333336,5.7714285714285696,6.590476190476191,4.7428571428571429,5.7833333333333323,6.3959999999999999,5.0000000000000009,5.8246913580246904,6.5215189873417732,5.3533333333333326,5.8126582278481003,6.6495145631067949,4.8136363636363635,5.8518072289156651,6.5987654320987668,4.6739130434782616,5.7753086419753092,6.664646464646462,4.3666666666666663,5.8808510638297893,6.2430232558139531,4.4285714285714288,5.5999999999999996,6.4947916666666687,4.3857142857142861,5.5793103448275865,6.460576923076923,4.6424242424242426,5.849999999999997,6.3673469387755111,4.418181818181818,5.6277777777777791,6.5193548387096767,4.6525000000000007,5.592307692307692,6.5114285714285742,4.9208333333333334,5.7097222222222195,6.417272727272727,4.9117647058823533,5.5071428571428545,6.7138297872340438,4.6533333333333333,5.6283018867924524,6.4406779661016937,4.7066666666666652,5.5999999999999979,6.4990384615384613,4.3599999999999994,5.6700000000000008,6.1859375000000005,4.0333333333333323,5.568421052631578,6.2865546218487376,4.8181818181818183,5.5431578947368427,6.2852713178294595,4.4153846153846157,5.4485148514851467,6.3037837837837829,4.208333333333333,5.4824675324675303,6.2863414634146411,4.2750000000000004,5.4579999999999957,6.2243781094527328,3.9947368421052634,5.4982456140350857,6.2783673469387686,4.2923076923076922,5.4666666666666659,6.2760683760683778,4.7230769230769232,5.3729927007299283,6.167256637168145,4.0473684210526315,5.2496453900709197,6.3157377049180292,3.9435897435897433,5.3703030303030328,6.2473354231974936,4.2166666666666668,5.2804347826086993,6.1714285714285708,4.0657142857142858,5.2814102564102559,6.2479338842975203,3.8637681159420283,5.1429347826086982,6.2348780487804838,4.1161290322580637,5.255319148936171,6.1822966507177055,4.0424242424242438,5.1939560439560459,6.1319612590799002,4.0253521126760576,5.243269230769231,6.1329326923076941,4.0236111111111104,5.180645161290319,6.2108843537414993,3.9182926829268285,5.272016460905351,6.2313283208020032,3.9614583333333346,5.3064000000000009,6.2682038834951399,4.1582524271844665,5.3087719298245615,6.163488372093024,3.9165137614678875,5.2498269896193728,6.2331096196868039,3.9650485436893192,5.3581481481481443,6.3322033898305055,4.346564885496182,5.3006688963210689,6.3104247104247113,4.3315789473684205,5.338823529411763,6.3932754880694107,4.1585106382978729,5.3600000000000003,6.4259615384615403,4.0628571428571432],"type":"box","marker":{"color":"rgba(31,119,180,1)","line":{"color":"rgba(31,119,180,1)"}},"line":{"color":"rgba(31,119,180,1)"},"xaxis":"x","yaxis":"y","frame":null}],"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.20000000000000001,"selected":{"opacity":1},"debounce":0},"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot","plotly_sunburstclick"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}</script>
```


## Группировка {-}
plotly очень дружелюбен к пользователю в тех задачах, когда есть данные в long-формате и нужно на одном графике отразить данные разных групп. Сложным решением тут была бы отрисовка графиков в цикле, однако можно просто воспользоваться аргументом `color` функции `plot_ly()`. 

Допустим, мы хотим отрисовать количество фильмов в год с разбивкой по жанрам. Для этого в параметр цвета передается название группирующей колонки:


```r
# считаем фильмы по режиссерам и странам
plot_ly(imdb_genres_scores, x = ~year, y = ~n_titles, type = 'bar', color = ~genre)
```

```{=html}
<div class="plotly html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-fb1017e40ced3e79e454" style="width:100%;height:480px;"></div>
<script type="application/json" data-for="htmlwidget-fb1017e40ced3e79e454">{"x":{"visdat":{"954471488644f":["function () ","plotlyVisDat"]},"cur_data":"954471488644f","attrs":{"954471488644f":{"x":{},"y":{},"color":{},"alpha_stroke":1,"sizes":[10,100],"spans":[1,20],"type":"bar"}},"layout":{"margin":{"b":40,"l":60,"t":25,"r":10},"xaxis":{"domain":[0,1],"automargin":true,"title":"year"},"yaxis":{"domain":[0,1],"automargin":true,"title":"n_titles"},"hovermode":"closest","showlegend":true},"source":"A","config":{"modeBarButtonsToAdd":["hoverclosest","hovercompare"],"showSendToCloud":false},"data":[{"x":[1914,1915,1916,1917,1918,1919,1920,1921,1923,1924,1925,1926,1927,1928,1929,1930,1931,1932,1933,1934,1935,1936,1937,1938,1939,1940,1941,1942,1943,1944,1945,1946,1947,1948,1949,1950,1951,1952,1953,1954,1955,1956,1957,1958,1959,1960,1961,1962,1963,1964,1965,1966,1967,1968,1969,1970,1971,1972,1973,1974,1975,1976,1977,1978,1979,1980,1981,1982,1983,1984,1985,1986,1987,1988,1989,1990,1991,1992,1993,1994,1995,1996,1997,1998,1999,2000,2001,2002,2003,2004,2005,2006,2007,2008,2009,2010,2011,2012,2013,2014,2015,2016,2017,2018,2019,2020],"y":[2,1,2,4,1,6,3,4,2,7,7,8,6,8,10,8,14,18,11,17,13,22,24,22,16,28,30,22,17,17,21,16,22,18,22,27,25,43,27,34,42,40,44,48,50,50,53,49,59,58,55,46,56,56,64,67,77,62,63,50,63,75,56,54,70,78,81,79,83,81,94,99,87,78,72,65,72,84,53,73,70,76,95,101,154,100,114,90,137,141,165,184,156,184,188,182,208,248,243,250,228,289,270,299,255,75],"type":"bar","name":"Comedy","marker":{"color":"rgba(102,194,165,1)","line":{"color":"rgba(102,194,165,1)"}},"textfont":{"color":"rgba(102,194,165,1)"},"error_y":{"color":"rgba(102,194,165,1)"},"error_x":{"color":"rgba(102,194,165,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":[1911,1912,1913,1914,1915,1916,1917,1918,1919,1920,1921,1922,1923,1924,1925,1926,1927,1928,1929,1930,1931,1932,1933,1934,1935,1936,1937,1938,1939,1940,1941,1942,1943,1944,1945,1946,1947,1948,1949,1950,1951,1952,1953,1954,1955,1956,1957,1958,1959,1960,1961,1962,1963,1964,1965,1966,1967,1968,1969,1970,1971,1972,1973,1974,1975,1976,1977,1978,1979,1980,1981,1982,1983,1984,1985,1986,1987,1988,1989,1990,1991,1992,1993,1994,1995,1996,1997,1998,1999,2000,2001,2002,2003,2004,2005,2006,2007,2008,2009,2010,2011,2012,2013,2014,2015,2016,2017,2018,2019,2020],"y":[1,1,3,5,11,7,5,9,10,12,17,10,8,11,17,14,10,18,30,18,31,49,41,44,33,20,24,19,29,25,16,9,14,10,16,27,30,47,33,36,36,45,31,38,36,57,45,49,55,54,75,69,72,59,57,67,64,78,86,102,89,71,88,80,65,85,86,82,84,75,79,103,81,99,86,96,104,98,93,105,110,94,118,104,128,119,129,185,205,201,245,234,226,305,319,364,363,410,418,413,416,441,399,412,430,447,531,518,461,104],"type":"bar","name":"Drama","marker":{"color":"rgba(252,141,98,1)","line":{"color":"rgba(252,141,98,1)"}},"textfont":{"color":"rgba(252,141,98,1)"},"error_y":{"color":"rgba(252,141,98,1)"},"error_x":{"color":"rgba(252,141,98,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":[1915,1917,1920,1925,1927,1928,1932,1934,1935,1940,1941,1945,1946,1948,1949,1951,1952,1953,1957,1958,1959,1960,1961,1962,1963,1964,1965,1966,1967,1968,1969,1970,1971,1972,1973,1974,1975,1976,1977,1978,1979,1980,1981,1982,1983,1984,1985,1986,1987,1988,1989,1990,1991,1992,1993,1994,1995,1996,1997,1998,1999,2000,2001,2002,2003,2004,2005,2006,2007,2008,2009,2010,2011,2012,2013,2014,2015,2016,2017,2018,2019,2020],"y":[1,1,1,1,1,1,1,2,1,2,1,1,3,2,1,1,1,1,10,2,6,9,9,9,13,17,10,13,8,20,10,18,38,37,41,32,19,22,20,18,21,16,30,22,23,9,14,14,33,44,40,24,17,15,15,10,12,11,13,12,16,19,13,13,19,39,54,70,69,62,66,71,72,82,96,103,109,103,131,133,94,35],"type":"bar","name":"Horror","marker":{"color":"rgba(141,160,203,1)","line":{"color":"rgba(141,160,203,1)"}},"textfont":{"color":"rgba(141,160,203,1)"},"error_y":{"color":"rgba(141,160,203,1)"},"error_x":{"color":"rgba(141,160,203,1)"},"xaxis":"x","yaxis":"y","frame":null}],"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.20000000000000001,"selected":{"opacity":1},"debounce":0},"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot","plotly_sunburstclick"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}</script>
```

В том случае, когда хочется нарисовать группы не отдельными столбиками, а стопкой, то надо указать аргумент `barmode = 'stack'` в отдельном слое `layout()` (о нем ниже, он используется для управления параметрами всего графика)


```r
plot_ly(imdb_genres_scores, x = ~year, y = ~n_titles, type = 'bar', color = ~genre) %>%
  layout(barmode = 'stack')
```

```{=html}
<div class="plotly html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-5da7f5586a5eff48b170" style="width:100%;height:480px;"></div>
<script type="application/json" data-for="htmlwidget-5da7f5586a5eff48b170">{"x":{"visdat":{"954475106a261":["function () ","plotlyVisDat"]},"cur_data":"954475106a261","attrs":{"954475106a261":{"x":{},"y":{},"color":{},"alpha_stroke":1,"sizes":[10,100],"spans":[1,20],"type":"bar"}},"layout":{"margin":{"b":40,"l":60,"t":25,"r":10},"barmode":"stack","xaxis":{"domain":[0,1],"automargin":true,"title":"year"},"yaxis":{"domain":[0,1],"automargin":true,"title":"n_titles"},"hovermode":"closest","showlegend":true},"source":"A","config":{"modeBarButtonsToAdd":["hoverclosest","hovercompare"],"showSendToCloud":false},"data":[{"x":[1914,1915,1916,1917,1918,1919,1920,1921,1923,1924,1925,1926,1927,1928,1929,1930,1931,1932,1933,1934,1935,1936,1937,1938,1939,1940,1941,1942,1943,1944,1945,1946,1947,1948,1949,1950,1951,1952,1953,1954,1955,1956,1957,1958,1959,1960,1961,1962,1963,1964,1965,1966,1967,1968,1969,1970,1971,1972,1973,1974,1975,1976,1977,1978,1979,1980,1981,1982,1983,1984,1985,1986,1987,1988,1989,1990,1991,1992,1993,1994,1995,1996,1997,1998,1999,2000,2001,2002,2003,2004,2005,2006,2007,2008,2009,2010,2011,2012,2013,2014,2015,2016,2017,2018,2019,2020],"y":[2,1,2,4,1,6,3,4,2,7,7,8,6,8,10,8,14,18,11,17,13,22,24,22,16,28,30,22,17,17,21,16,22,18,22,27,25,43,27,34,42,40,44,48,50,50,53,49,59,58,55,46,56,56,64,67,77,62,63,50,63,75,56,54,70,78,81,79,83,81,94,99,87,78,72,65,72,84,53,73,70,76,95,101,154,100,114,90,137,141,165,184,156,184,188,182,208,248,243,250,228,289,270,299,255,75],"type":"bar","name":"Comedy","marker":{"color":"rgba(102,194,165,1)","line":{"color":"rgba(102,194,165,1)"}},"textfont":{"color":"rgba(102,194,165,1)"},"error_y":{"color":"rgba(102,194,165,1)"},"error_x":{"color":"rgba(102,194,165,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":[1911,1912,1913,1914,1915,1916,1917,1918,1919,1920,1921,1922,1923,1924,1925,1926,1927,1928,1929,1930,1931,1932,1933,1934,1935,1936,1937,1938,1939,1940,1941,1942,1943,1944,1945,1946,1947,1948,1949,1950,1951,1952,1953,1954,1955,1956,1957,1958,1959,1960,1961,1962,1963,1964,1965,1966,1967,1968,1969,1970,1971,1972,1973,1974,1975,1976,1977,1978,1979,1980,1981,1982,1983,1984,1985,1986,1987,1988,1989,1990,1991,1992,1993,1994,1995,1996,1997,1998,1999,2000,2001,2002,2003,2004,2005,2006,2007,2008,2009,2010,2011,2012,2013,2014,2015,2016,2017,2018,2019,2020],"y":[1,1,3,5,11,7,5,9,10,12,17,10,8,11,17,14,10,18,30,18,31,49,41,44,33,20,24,19,29,25,16,9,14,10,16,27,30,47,33,36,36,45,31,38,36,57,45,49,55,54,75,69,72,59,57,67,64,78,86,102,89,71,88,80,65,85,86,82,84,75,79,103,81,99,86,96,104,98,93,105,110,94,118,104,128,119,129,185,205,201,245,234,226,305,319,364,363,410,418,413,416,441,399,412,430,447,531,518,461,104],"type":"bar","name":"Drama","marker":{"color":"rgba(252,141,98,1)","line":{"color":"rgba(252,141,98,1)"}},"textfont":{"color":"rgba(252,141,98,1)"},"error_y":{"color":"rgba(252,141,98,1)"},"error_x":{"color":"rgba(252,141,98,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":[1915,1917,1920,1925,1927,1928,1932,1934,1935,1940,1941,1945,1946,1948,1949,1951,1952,1953,1957,1958,1959,1960,1961,1962,1963,1964,1965,1966,1967,1968,1969,1970,1971,1972,1973,1974,1975,1976,1977,1978,1979,1980,1981,1982,1983,1984,1985,1986,1987,1988,1989,1990,1991,1992,1993,1994,1995,1996,1997,1998,1999,2000,2001,2002,2003,2004,2005,2006,2007,2008,2009,2010,2011,2012,2013,2014,2015,2016,2017,2018,2019,2020],"y":[1,1,1,1,1,1,1,2,1,2,1,1,3,2,1,1,1,1,10,2,6,9,9,9,13,17,10,13,8,20,10,18,38,37,41,32,19,22,20,18,21,16,30,22,23,9,14,14,33,44,40,24,17,15,15,10,12,11,13,12,16,19,13,13,19,39,54,70,69,62,66,71,72,82,96,103,109,103,131,133,94,35],"type":"bar","name":"Horror","marker":{"color":"rgba(141,160,203,1)","line":{"color":"rgba(141,160,203,1)"}},"textfont":{"color":"rgba(141,160,203,1)"},"error_y":{"color":"rgba(141,160,203,1)"},"error_x":{"color":"rgba(141,160,203,1)"},"xaxis":"x","yaxis":"y","frame":null}],"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.20000000000000001,"selected":{"opacity":1},"debounce":0},"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot","plotly_sunburstclick"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}</script>
```

<br>

## Визуальные параметры графиков {-}

### Легенда {-}
Название элементов графика задается параметром `name` в графике. В него можно как передать какое-то значение, так и колонку, которая задает названия. Когда одна линия, то легенда не формируется. 

```r
plot_ly(imdb_woody, x = ~year, y = ~avg_vote, 
        type = 'scatter', mode = 'markers+lines', name = 'markers+lines')
```

```{=html}
<div class="plotly html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-5bb7673e8e723632f963" style="width:100%;height:480px;"></div>
<script type="application/json" data-for="htmlwidget-5bb7673e8e723632f963">{"x":{"visdat":{"95447443569a3":["function () ","plotlyVisDat"]},"cur_data":"95447443569a3","attrs":{"95447443569a3":{"x":{},"y":{},"mode":"markers+lines","name":"markers+lines","alpha_stroke":1,"sizes":[10,100],"spans":[1,20],"type":"scatter"}},"layout":{"margin":{"b":40,"l":60,"t":25,"r":10},"xaxis":{"domain":[0,1],"automargin":true,"title":"year"},"yaxis":{"domain":[0,1],"automargin":true,"title":"avg_vote"},"hovermode":"closest","showlegend":false},"source":"A","config":{"modeBarButtonsToAdd":["hoverclosest","hovercompare"],"showSendToCloud":false},"data":[{"x":[1969,1971,1972,1973,1975,1977,1978,1979,1980,1982,1983,1984,1985,1986,1987,1987,1988,1989,1990,1992,1991,1993,1994,1995,1996,1997,1998,1999,2000,2001,2002,2003,2004,2005,2006,2008,2007,2009,2010,2011,2012,2013,2014,2015,2016,2017,2019],"y":[7.2999999999999998,7,6.7999999999999998,7.2000000000000002,7.7000000000000002,8,7.4000000000000004,7.9000000000000004,7.2999999999999998,6.5999999999999996,7.7000000000000002,7.4000000000000004,7.7000000000000002,7.9000000000000004,7.5,6.5,7.2999999999999998,7.9000000000000004,6.5999999999999996,7.5,6.7000000000000002,7.4000000000000004,7.4000000000000004,7,6.7000000000000002,7.4000000000000004,6.2999999999999998,7.2000000000000002,6.7000000000000002,6.7000000000000002,6.5999999999999996,6.2999999999999998,6.4000000000000004,7.5999999999999996,6.7000000000000002,7.0999999999999996,6.7000000000000002,7.0999999999999996,6.2999999999999998,7.7000000000000002,6.2999999999999998,7.2999999999999998,6.5,6.5999999999999996,6.5999999999999996,6.2000000000000002,6.5999999999999996],"mode":"markers+lines","name":"markers+lines","type":"scatter","marker":{"color":"rgba(31,119,180,1)","line":{"color":"rgba(31,119,180,1)"}},"error_y":{"color":"rgba(31,119,180,1)"},"error_x":{"color":"rgba(31,119,180,1)"},"line":{"color":"rgba(31,119,180,1)"},"xaxis":"x","yaxis":"y","frame":null}],"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.20000000000000001,"selected":{"opacity":1},"debounce":0},"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot","plotly_sunburstclick"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}</script>
```

Легенду можно скрыть параметром `showlegend=FALSE`:

```r
plot_ly(imdb_woody, x = ~year, y = ~avg_vote, 
        type = 'scatter', mode = 'markers+lines', name = 'markers+lines', 
        showlegend = FALSE)
```

```{=html}
<div class="plotly html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-44c342b3b8834e71caf4" style="width:100%;height:480px;"></div>
<script type="application/json" data-for="htmlwidget-44c342b3b8834e71caf4">{"x":{"visdat":{"95447225dac82":["function () ","plotlyVisDat"]},"cur_data":"95447225dac82","attrs":{"95447225dac82":{"x":{},"y":{},"mode":"markers+lines","showlegend":false,"name":"markers+lines","alpha_stroke":1,"sizes":[10,100],"spans":[1,20],"type":"scatter"}},"layout":{"margin":{"b":40,"l":60,"t":25,"r":10},"xaxis":{"domain":[0,1],"automargin":true,"title":"year"},"yaxis":{"domain":[0,1],"automargin":true,"title":"avg_vote"},"hovermode":"closest","showlegend":false},"source":"A","config":{"modeBarButtonsToAdd":["hoverclosest","hovercompare"],"showSendToCloud":false},"data":[{"x":[1969,1971,1972,1973,1975,1977,1978,1979,1980,1982,1983,1984,1985,1986,1987,1987,1988,1989,1990,1992,1991,1993,1994,1995,1996,1997,1998,1999,2000,2001,2002,2003,2004,2005,2006,2008,2007,2009,2010,2011,2012,2013,2014,2015,2016,2017,2019],"y":[7.2999999999999998,7,6.7999999999999998,7.2000000000000002,7.7000000000000002,8,7.4000000000000004,7.9000000000000004,7.2999999999999998,6.5999999999999996,7.7000000000000002,7.4000000000000004,7.7000000000000002,7.9000000000000004,7.5,6.5,7.2999999999999998,7.9000000000000004,6.5999999999999996,7.5,6.7000000000000002,7.4000000000000004,7.4000000000000004,7,6.7000000000000002,7.4000000000000004,6.2999999999999998,7.2000000000000002,6.7000000000000002,6.7000000000000002,6.5999999999999996,6.2999999999999998,6.4000000000000004,7.5999999999999996,6.7000000000000002,7.0999999999999996,6.7000000000000002,7.0999999999999996,6.2999999999999998,7.7000000000000002,6.2999999999999998,7.2999999999999998,6.5,6.5999999999999996,6.5999999999999996,6.2000000000000002,6.5999999999999996],"mode":"markers+lines","showlegend":false,"name":"markers+lines","type":"scatter","marker":{"color":"rgba(31,119,180,1)","line":{"color":"rgba(31,119,180,1)"}},"error_y":{"color":"rgba(31,119,180,1)"},"error_x":{"color":"rgba(31,119,180,1)"},"line":{"color":"rgba(31,119,180,1)"},"xaxis":"x","yaxis":"y","frame":null}],"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.20000000000000001,"selected":{"opacity":1},"debounce":0},"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot","plotly_sunburstclick"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}</script>
```

  

### Параметры линий и точек {-}
Линии и точки на графиках можно изменять на свой вкус - менять типы линий, размеры элементов, цвет. Параметры элементов задают через значения аргументов `marker` (для точек) или `line` для линий.


```r
plot_ly(
  data = imdb_woody, 
  x = ~year, y = ~avg_vote,
  type = 'scatter', mode = 'markers',
  color = ~country,
  marker = list(
    size = ~duration / 10,
    symbol = 'diamond'
  )
)
```

```{=html}
<div class="plotly html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-642b53b288680c5c777b" style="width:100%;height:480px;"></div>
<script type="application/json" data-for="htmlwidget-642b53b288680c5c777b">{"x":{"visdat":{"954477725998":["function () ","plotlyVisDat"]},"cur_data":"954477725998","attrs":{"954477725998":{"x":{},"y":{},"mode":"markers","marker":{"size":{},"symbol":"diamond"},"color":{},"alpha_stroke":1,"sizes":[10,100],"spans":[1,20],"type":"scatter"}},"layout":{"margin":{"b":40,"l":60,"t":25,"r":10},"xaxis":{"domain":[0,1],"automargin":true,"title":"year"},"yaxis":{"domain":[0,1],"automargin":true,"title":"avg_vote"},"hovermode":"closest","showlegend":true},"source":"A","config":{"modeBarButtonsToAdd":["hoverclosest","hovercompare"],"showSendToCloud":false},"data":[{"x":[2008],"y":[7.0999999999999996],"mode":"markers","marker":{"color":"rgba(102,194,165,1)","size":8.5,"symbol":"diamond","line":{"color":"rgba(102,194,165,1)"}},"type":"scatter","name":"Spain, USA","textfont":{"color":"rgba(102,194,165,1)"},"error_y":{"color":"rgba(102,194,165,1)"},"error_x":{"color":"rgba(102,194,165,1)"},"line":{"color":"rgba(102,194,165,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":[2011],"y":[7.7000000000000002],"mode":"markers","marker":{"color":"rgba(219,161,118,1)","size":8.1999999999999993,"symbol":"diamond","line":{"color":"rgba(219,161,118,1)"}},"type":"scatter","name":"Spain, USA, France","textfont":{"color":"rgba(219,161,118,1)"},"error_y":{"color":"rgba(219,161,118,1)"},"error_x":{"color":"rgba(219,161,118,1)"},"line":{"color":"rgba(219,161,118,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":[2006],"y":[6.7000000000000002],"mode":"markers","marker":{"color":"rgba(217,150,141,1)","size":8.8000000000000007,"symbol":"diamond","line":{"color":"rgba(217,150,141,1)"}},"type":"scatter","name":"UK, USA","textfont":{"color":"rgba(217,150,141,1)"},"error_y":{"color":"rgba(217,150,141,1)"},"error_x":{"color":"rgba(217,150,141,1)"},"line":{"color":"rgba(217,150,141,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":[2005],"y":[7.5999999999999996],"mode":"markers","marker":{"color":"rgba(152,158,202,1)","size":8.9000000000000004,"symbol":"diamond","line":{"color":"rgba(152,158,202,1)"}},"type":"scatter","name":"UK, USA, Ireland, Luxembourg, France","textfont":{"color":"rgba(152,158,202,1)"},"error_y":{"color":"rgba(152,158,202,1)"},"error_x":{"color":"rgba(152,158,202,1)"},"line":{"color":"rgba(152,158,202,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":[1969,1971,1972,1973,1975,1977,1978,1979,1980,1982,1983,1984,1985,1986,1987,1987,1988,1989,1990,1992,1991,1993,1994,1995,1996,1997,1998,1999,2000,2002,2004,2013,2015,2016,2017,2019],"y":[7.2999999999999998,7,6.7999999999999998,7.2000000000000002,7.7000000000000002,8,7.4000000000000004,7.9000000000000004,7.2999999999999998,6.5999999999999996,7.7000000000000002,7.4000000000000004,7.7000000000000002,7.9000000000000004,7.5,6.5,7.2999999999999998,7.9000000000000004,6.5999999999999996,7.5,6.7000000000000002,7.4000000000000004,7.4000000000000004,7,6.7000000000000002,7.4000000000000004,6.2999999999999998,7.2000000000000002,6.7000000000000002,6.5999999999999996,6.4000000000000004,7.2999999999999998,6.5999999999999996,6.5999999999999996,6.2000000000000002,6.5999999999999996],"mode":"markers","marker":{"color":"rgba(215,144,197,1)","size":[8.5,9.3000000000000007,9.1999999999999993,9.5999999999999996,8.9000000000000004,8.8000000000000007,7.9000000000000004,8.4000000000000004,8.1999999999999993,10.699999999999999,8.8000000000000007,8.3000000000000007,8.0999999999999996,10.4,10.6,10.800000000000001,8.5,10.4,9.8000000000000007,9.5,10.1,9.5999999999999996,11.300000000000001,9.5,9.4000000000000004,10.300000000000001,11.199999999999999,10.800000000000001,9.9000000000000004,12.4,9.5999999999999996,9.5999999999999996,10.800000000000001,9.3000000000000007,9.8000000000000007,9.5999999999999996],"symbol":"diamond","line":{"color":"rgba(215,144,197,1)"}},"type":"scatter","name":"USA","textfont":{"color":"rgba(215,144,197,1)"},"error_y":{"color":"rgba(215,144,197,1)"},"error_x":{"color":"rgba(215,144,197,1)"},"line":{"color":"rgba(215,144,197,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":[2009,2014],"y":[7.0999999999999996,6.5],"mode":"markers","marker":{"color":"rgba(205,180,144,1)","size":[11.199999999999999,9.8000000000000007],"symbol":"diamond","line":{"color":"rgba(205,180,144,1)"}},"type":"scatter","name":"USA, France","textfont":{"color":"rgba(205,180,144,1)"},"error_y":{"color":"rgba(205,180,144,1)"},"error_x":{"color":"rgba(205,180,144,1)"},"line":{"color":"rgba(205,180,144,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":[2003],"y":[6.2999999999999998],"mode":"markers","marker":{"color":"rgba(186,217,78,1)","size":9.6999999999999993,"symbol":"diamond","line":{"color":"rgba(186,217,78,1)"}},"type":"scatter","name":"USA, France, UK","textfont":{"color":"rgba(186,217,78,1)"},"error_y":{"color":"rgba(186,217,78,1)"},"error_x":{"color":"rgba(186,217,78,1)"},"line":{"color":"rgba(186,217,78,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":[2001],"y":[6.7000000000000002],"mode":"markers","marker":{"color":"rgba(247,217,52,1)","size":9.5,"symbol":"diamond","line":{"color":"rgba(247,217,52,1)"}},"type":"scatter","name":"USA, Germany","textfont":{"color":"rgba(247,217,52,1)"},"error_y":{"color":"rgba(247,217,52,1)"},"error_x":{"color":"rgba(247,217,52,1)"},"line":{"color":"rgba(247,217,52,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":[2012],"y":[6.2999999999999998],"mode":"markers","marker":{"color":"rgba(241,204,114,1)","size":9.5999999999999996,"symbol":"diamond","line":{"color":"rgba(241,204,114,1)"}},"type":"scatter","name":"USA, Italy, Spain","textfont":{"color":"rgba(241,204,114,1)"},"error_y":{"color":"rgba(241,204,114,1)"},"error_x":{"color":"rgba(241,204,114,1)"},"line":{"color":"rgba(241,204,114,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":[2010],"y":[6.2999999999999998],"mode":"markers","marker":{"color":"rgba(215,191,158,1)","size":10.1,"symbol":"diamond","line":{"color":"rgba(215,191,158,1)"}},"type":"scatter","name":"USA, Spain","textfont":{"color":"rgba(215,191,158,1)"},"error_y":{"color":"rgba(215,191,158,1)"},"error_x":{"color":"rgba(215,191,158,1)"},"line":{"color":"rgba(215,191,158,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":[2007],"y":[6.7000000000000002],"mode":"markers","marker":{"color":"rgba(179,179,179,1)","size":9.1999999999999993,"symbol":"diamond","line":{"color":"rgba(179,179,179,1)"}},"type":"scatter","name":"USA, UK, France","textfont":{"color":"rgba(179,179,179,1)"},"error_y":{"color":"rgba(179,179,179,1)"},"error_x":{"color":"rgba(179,179,179,1)"},"line":{"color":"rgba(179,179,179,1)"},"xaxis":"x","yaxis":"y","frame":null}],"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.20000000000000001,"selected":{"opacity":1},"debounce":0},"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot","plotly_sunburstclick"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}</script>
```

Линии задаются также аргументом, в который надо передавать спиcок параметров, обычно это размер, тип линии или ее форма. Типы линий, которые доступны в plotly: "solid", "dot", "dash", "longdash", "dashdot":

```r
plot_ly(
  data = imdb_woody, 
  x = ~year, y = ~avg_vote,
  type = 'scatter', mode = 'lines',
  color = ~country,
  line = list(
    color = 'steelblue',
    size = 3,
    dash = 'dash'
  )
)
```

```{=html}
<div class="plotly html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-740d9df4f944fb9c0b3e" style="width:100%;height:480px;"></div>
<script type="application/json" data-for="htmlwidget-740d9df4f944fb9c0b3e">{"x":{"visdat":{"954478690ba2":["function () ","plotlyVisDat"]},"cur_data":"954478690ba2","attrs":{"954478690ba2":{"x":{},"y":{},"mode":"lines","line":{"color":"steelblue","size":3,"dash":"dash"},"color":{},"alpha_stroke":1,"sizes":[10,100],"spans":[1,20],"type":"scatter"}},"layout":{"margin":{"b":40,"l":60,"t":25,"r":10},"xaxis":{"domain":[0,1],"automargin":true,"title":"year"},"yaxis":{"domain":[0,1],"automargin":true,"title":"avg_vote"},"hovermode":"closest","showlegend":true},"source":"A","config":{"modeBarButtonsToAdd":["hoverclosest","hovercompare"],"showSendToCloud":false},"data":[{"x":[2008],"y":[7.0999999999999996],"mode":"lines","line":{"color":"steelblue","size":3,"dash":"dash"},"type":"scatter","name":"Spain, USA","marker":{"color":"rgba(102,194,165,1)","line":{"color":"rgba(102,194,165,1)"}},"textfont":{"color":"rgba(102,194,165,1)"},"error_y":{"color":"rgba(102,194,165,1)"},"error_x":{"color":"rgba(102,194,165,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":[2011],"y":[7.7000000000000002],"mode":"lines","line":{"color":"steelblue","size":3,"dash":"dash"},"type":"scatter","name":"Spain, USA, France","marker":{"color":"rgba(219,161,118,1)","line":{"color":"rgba(219,161,118,1)"}},"textfont":{"color":"rgba(219,161,118,1)"},"error_y":{"color":"rgba(219,161,118,1)"},"error_x":{"color":"rgba(219,161,118,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":[2006],"y":[6.7000000000000002],"mode":"lines","line":{"color":"steelblue","size":3,"dash":"dash"},"type":"scatter","name":"UK, USA","marker":{"color":"rgba(217,150,141,1)","line":{"color":"rgba(217,150,141,1)"}},"textfont":{"color":"rgba(217,150,141,1)"},"error_y":{"color":"rgba(217,150,141,1)"},"error_x":{"color":"rgba(217,150,141,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":[2005],"y":[7.5999999999999996],"mode":"lines","line":{"color":"steelblue","size":3,"dash":"dash"},"type":"scatter","name":"UK, USA, Ireland, Luxembourg, France","marker":{"color":"rgba(152,158,202,1)","line":{"color":"rgba(152,158,202,1)"}},"textfont":{"color":"rgba(152,158,202,1)"},"error_y":{"color":"rgba(152,158,202,1)"},"error_x":{"color":"rgba(152,158,202,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":[1969,1971,1972,1973,1975,1977,1978,1979,1980,1982,1983,1984,1985,1986,1987,1987,1988,1989,1990,1992,1991,1993,1994,1995,1996,1997,1998,1999,2000,2002,2004,2013,2015,2016,2017,2019],"y":[7.2999999999999998,7,6.7999999999999998,7.2000000000000002,7.7000000000000002,8,7.4000000000000004,7.9000000000000004,7.2999999999999998,6.5999999999999996,7.7000000000000002,7.4000000000000004,7.7000000000000002,7.9000000000000004,7.5,6.5,7.2999999999999998,7.9000000000000004,6.5999999999999996,7.5,6.7000000000000002,7.4000000000000004,7.4000000000000004,7,6.7000000000000002,7.4000000000000004,6.2999999999999998,7.2000000000000002,6.7000000000000002,6.5999999999999996,6.4000000000000004,7.2999999999999998,6.5999999999999996,6.5999999999999996,6.2000000000000002,6.5999999999999996],"mode":"lines","line":{"color":"steelblue","size":3,"dash":"dash"},"type":"scatter","name":"USA","marker":{"color":"rgba(215,144,197,1)","line":{"color":"rgba(215,144,197,1)"}},"textfont":{"color":"rgba(215,144,197,1)"},"error_y":{"color":"rgba(215,144,197,1)"},"error_x":{"color":"rgba(215,144,197,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":[2009,2014],"y":[7.0999999999999996,6.5],"mode":"lines","line":{"color":"steelblue","size":3,"dash":"dash"},"type":"scatter","name":"USA, France","marker":{"color":"rgba(205,180,144,1)","line":{"color":"rgba(205,180,144,1)"}},"textfont":{"color":"rgba(205,180,144,1)"},"error_y":{"color":"rgba(205,180,144,1)"},"error_x":{"color":"rgba(205,180,144,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":[2003],"y":[6.2999999999999998],"mode":"lines","line":{"color":"steelblue","size":3,"dash":"dash"},"type":"scatter","name":"USA, France, UK","marker":{"color":"rgba(186,217,78,1)","line":{"color":"rgba(186,217,78,1)"}},"textfont":{"color":"rgba(186,217,78,1)"},"error_y":{"color":"rgba(186,217,78,1)"},"error_x":{"color":"rgba(186,217,78,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":[2001],"y":[6.7000000000000002],"mode":"lines","line":{"color":"steelblue","size":3,"dash":"dash"},"type":"scatter","name":"USA, Germany","marker":{"color":"rgba(247,217,52,1)","line":{"color":"rgba(247,217,52,1)"}},"textfont":{"color":"rgba(247,217,52,1)"},"error_y":{"color":"rgba(247,217,52,1)"},"error_x":{"color":"rgba(247,217,52,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":[2012],"y":[6.2999999999999998],"mode":"lines","line":{"color":"steelblue","size":3,"dash":"dash"},"type":"scatter","name":"USA, Italy, Spain","marker":{"color":"rgba(241,204,114,1)","line":{"color":"rgba(241,204,114,1)"}},"textfont":{"color":"rgba(241,204,114,1)"},"error_y":{"color":"rgba(241,204,114,1)"},"error_x":{"color":"rgba(241,204,114,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":[2010],"y":[6.2999999999999998],"mode":"lines","line":{"color":"steelblue","size":3,"dash":"dash"},"type":"scatter","name":"USA, Spain","marker":{"color":"rgba(215,191,158,1)","line":{"color":"rgba(215,191,158,1)"}},"textfont":{"color":"rgba(215,191,158,1)"},"error_y":{"color":"rgba(215,191,158,1)"},"error_x":{"color":"rgba(215,191,158,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":[2007],"y":[6.7000000000000002],"mode":"lines","line":{"color":"steelblue","size":3,"dash":"dash"},"type":"scatter","name":"USA, UK, France","marker":{"color":"rgba(179,179,179,1)","line":{"color":"rgba(179,179,179,1)"}},"textfont":{"color":"rgba(179,179,179,1)"},"error_y":{"color":"rgba(179,179,179,1)"},"error_x":{"color":"rgba(179,179,179,1)"},"xaxis":"x","yaxis":"y","frame":null}],"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.20000000000000001,"selected":{"opacity":1},"debounce":0},"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot","plotly_sunburstclick"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}</script>
```

<br>

### Ховеры {-}
Ховеры, в общем виде, это разного рода эффекты (всплывающие подписи, подсказки, плавные переходы, трансформация, ротация, увеличение, смещение и пр.), которые наблюдаются при наведении на них курсора мыши. В plotly ховеры - это всплывающие подписи, которые содержат информацию о координатах (по умолчанию).

При желании, можно изменить содержание ховеров. Для этого необходимо создать отдельную колонку, в которой в виде строки будут записаны все необходимые параметры, которые хочется показывать в ховере. При этом для кастомизации записи можно использовать html-теги, хотя бы тег `<br>` для разделения значений по строчкам.

```r
# создадим колонку с информацией о годе, оценке, названии и жанре фильма
imdb_lynch[, my_hover := paste(
  'year =', year, '<br>',
  'imdb score =', avg_vote, '<br>',
  'title = ', original_title, '<br>',
  'genres =', genre)]

# смотрим результат
imdb_lynch[1:3, my_hover]
```

```
## [1] "year = 1977 <br> imdb score = 7.4 <br> title =  Eraserhead <br> genres = Fantasy, Horror"       
## [2] "year = 1980 <br> imdb score = 8.1 <br> title =  The Elephant Man <br> genres = Biography, Drama"
## [3] "year = 1984 <br> imdb score = 6.5 <br> title =  Dune <br> genres = Action, Adventure, Sci-Fi"
```

Указываем созданную переменную для использования в качестве ховера:

```r
plot_ly(imdb_lynch, x = ~year, y = ~avg_vote,
        type = 'scatter', mode = 'markers', 
        text = ~my_hover, hoverinfo = 'text')
```

```{=html}
<div class="plotly html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-7af21ef74230160dd317" style="width:100%;height:480px;"></div>
<script type="application/json" data-for="htmlwidget-7af21ef74230160dd317">{"x":{"visdat":{"9544765f86af8":["function () ","plotlyVisDat"]},"cur_data":"9544765f86af8","attrs":{"9544765f86af8":{"x":{},"y":{},"mode":"markers","text":{},"hoverinfo":"text","alpha_stroke":1,"sizes":[10,100],"spans":[1,20],"type":"scatter"}},"layout":{"margin":{"b":40,"l":60,"t":25,"r":10},"xaxis":{"domain":[0,1],"automargin":true,"title":"year"},"yaxis":{"domain":[0,1],"automargin":true,"title":"avg_vote"},"hovermode":"closest","showlegend":false},"source":"A","config":{"modeBarButtonsToAdd":["hoverclosest","hovercompare"],"showSendToCloud":false},"data":[{"x":[1977,1980,1984,1986,1990,1992,1997,1999,2001,2006,2014],"y":[7.4000000000000004,8.0999999999999996,6.5,7.7000000000000002,7.2000000000000002,7.2999999999999998,7.5999999999999996,8,8,6.9000000000000004,7.7000000000000002],"mode":"markers","text":["year = 1977 <br> imdb score = 7.4 <br> title =  Eraserhead <br> genres = Fantasy, Horror","year = 1980 <br> imdb score = 8.1 <br> title =  The Elephant Man <br> genres = Biography, Drama","year = 1984 <br> imdb score = 6.5 <br> title =  Dune <br> genres = Action, Adventure, Sci-Fi","year = 1986 <br> imdb score = 7.7 <br> title =  Blue Velvet <br> genres = Drama, Mystery, Thriller","year = 1990 <br> imdb score = 7.2 <br> title =  Wild at Heart <br> genres = Comedy, Crime, Drama","year = 1992 <br> imdb score = 7.3 <br> title =  Twin Peaks: Fire Walk with Me <br> genres = Drama, Horror, Mystery","year = 1997 <br> imdb score = 7.6 <br> title =  Lost Highway <br> genres = Mystery, Thriller","year = 1999 <br> imdb score = 8 <br> title =  The Straight Story <br> genres = Biography, Drama","year = 2001 <br> imdb score = 8 <br> title =  Mulholland Dr. <br> genres = Drama, Mystery, Thriller","year = 2006 <br> imdb score = 6.9 <br> title =  Inland Empire <br> genres = Drama, Fantasy, Mystery","year = 2014 <br> imdb score = 7.7 <br> title =  Twin Peaks: The Missing Pieces <br> genres = Drama, Horror, Mystery"],"hoverinfo":["text","text","text","text","text","text","text","text","text","text","text"],"type":"scatter","marker":{"color":"rgba(31,119,180,1)","line":{"color":"rgba(31,119,180,1)"}},"error_y":{"color":"rgba(31,119,180,1)"},"error_x":{"color":"rgba(31,119,180,1)"},"line":{"color":"rgba(31,119,180,1)"},"xaxis":"x","yaxis":"y","frame":null}],"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.20000000000000001,"selected":{"opacity":1},"debounce":0},"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot","plotly_sunburstclick"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}</script>
```

<br>

```r
imdb_lynch[, my_hover := NULL]
```

## Добавляемые слои {-}
### Наследование параметров {-}
plotly в немалой части следует идеологии grammar of graphics, которая реализована в ggplot2. В частности, идее слоев и сочетания разных данных и типов графиков на одном пространстве координат. Конечно, очень разные по типу графики совместить сложно или невозможно, но совмещение линий, точек и баров, линий и боксплотов, и т.д. встречается очень часто.

В частности, наложение графиков используется в ситуациях, когда данные необходимо отрисовать из разных колонок. Так, в данных по занятости населения США по строкам расположены года наблюдений, а в отдельных колонка - количество населения (pop) и количестве безработных (unemployed). Можно трансформировать датасет и перевести его в long-формат, однако проще добавить к графику еще один слой (след, trace, в терминологии plotly). Для каждого трейса можно задать свое название:


```r
plot_ly(imdb_genres_scores[genre == 'Horror'], x = ~year, y = ~votes,
        type = 'scatter', mode = 'lines') %>%
  add_trace(data = imdb_genres_scores[genre == 'Drama'], x = ~year, y = ~votes,
        type = 'scatter', mode = 'lines')
```

```{=html}
<div class="plotly html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-7422ff94f5f3a39b1710" style="width:100%;height:480px;"></div>
<script type="application/json" data-for="htmlwidget-7422ff94f5f3a39b1710">{"x":{"visdat":{"954476b75562e":["function () ","plotlyVisDat"],"9544775e0b8a6":["function () ","data"]},"cur_data":"9544775e0b8a6","attrs":{"954476b75562e":{"x":{},"y":{},"mode":"lines","alpha_stroke":1,"sizes":[10,100],"spans":[1,20],"type":"scatter"},"9544775e0b8a6":{"x":{},"y":{},"mode":"lines","alpha_stroke":1,"sizes":[10,100],"spans":[1,20],"type":"scatter","inherit":true}},"layout":{"margin":{"b":40,"l":60,"t":25,"r":10},"xaxis":{"domain":[0,1],"automargin":true,"title":"year"},"yaxis":{"domain":[0,1],"automargin":true,"title":"votes"},"hovermode":"closest","showlegend":true},"source":"A","config":{"modeBarButtonsToAdd":["hoverclosest","hovercompare"],"showSendToCloud":false},"data":[{"x":[1915,1917,1920,1925,1927,1928,1932,1934,1935,1940,1941,1945,1946,1948,1949,1951,1952,1953,1957,1958,1959,1960,1961,1962,1963,1964,1965,1966,1967,1968,1969,1970,1971,1972,1973,1974,1975,1976,1977,1978,1979,1980,1981,1982,1983,1984,1985,1986,1987,1988,1989,1990,1991,1992,1993,1994,1995,1996,1997,1998,1999,2000,2001,2002,2003,2004,2005,2006,2007,2008,2009,2010,2011,2012,2013,2014,2015,2016,2017,2018,2019,2020],"y":[6.7999999999999998,6.0999999999999996,6,7.5999999999999996,6.7999999999999998,7.2999999999999998,6.2999999999999998,3.6500000000000004,7.0999999999999996,4.25,7.2999999999999998,6,4.8666666666666663,4.9499999999999993,7.0999999999999996,4.4000000000000004,5.5999999999999996,7.0999999999999996,5.0700000000000003,5.0499999999999998,5.8999999999999995,5.7222222222222223,5.0666666666666664,5.5444444444444452,5.8076923076923084,5.6352941176470601,4.6600000000000001,5.3769230769230756,5.0250000000000004,5.4699999999999998,4.96,5.0111111111111111,5.1552631578947361,4.8405405405405393,5.3414634146341466,4.8625000000000007,4.6315789473684212,5.1227272727272721,4.9650000000000007,4.9333333333333336,4.7428571428571429,5.0000000000000009,5.3533333333333326,4.8136363636363635,4.6739130434782616,4.3666666666666663,4.4285714285714288,4.3857142857142861,4.6424242424242426,4.418181818181818,4.6525000000000007,4.9208333333333334,4.9117647058823533,4.6533333333333333,4.7066666666666652,4.3599999999999994,4.0333333333333323,4.8181818181818183,4.4153846153846157,4.208333333333333,4.2750000000000004,3.9947368421052634,4.2923076923076922,4.7230769230769232,4.0473684210526315,3.9435897435897433,4.2166666666666668,4.0657142857142858,3.8637681159420283,4.1161290322580637,4.0424242424242438,4.0253521126760576,4.0236111111111104,3.9182926829268285,3.9614583333333346,4.1582524271844665,3.9165137614678875,3.9650485436893192,4.346564885496182,4.3315789473684205,4.1585106382978729,4.0628571428571432],"mode":"lines","type":"scatter","marker":{"color":"rgba(31,119,180,1)","line":{"color":"rgba(31,119,180,1)"}},"error_y":{"color":"rgba(31,119,180,1)"},"error_x":{"color":"rgba(31,119,180,1)"},"line":{"color":"rgba(31,119,180,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":[1911,1912,1913,1914,1915,1916,1917,1918,1919,1920,1921,1922,1923,1924,1925,1926,1927,1928,1929,1930,1931,1932,1933,1934,1935,1936,1937,1938,1939,1940,1941,1942,1943,1944,1945,1946,1947,1948,1949,1950,1951,1952,1953,1954,1955,1956,1957,1958,1959,1960,1961,1962,1963,1964,1965,1966,1967,1968,1969,1970,1971,1972,1973,1974,1975,1976,1977,1978,1979,1980,1981,1982,1983,1984,1985,1986,1987,1988,1989,1990,1991,1992,1993,1994,1995,1996,1997,1998,1999,2000,2001,2002,2003,2004,2005,2006,2007,2008,2009,2010,2011,2012,2013,2014,2015,2016,2017,2018,2019,2020],"y":[5.7999999999999998,5.5,6.7666666666666657,5.9000000000000004,6.327272727272728,6.2999999999999998,6.5800000000000001,6.1888888888888891,6.1600000000000001,6.1166666666666671,6.5764705882352947,6.4400000000000004,6.6624999999999996,6.6454545454545464,6.5294117647058814,6.8928571428571432,6.1999999999999993,6.4944444444444445,6.6099999999999994,6.477777777777777,6.2999999999999998,6.4857142857142875,6.4951219512195122,6.4840909090909102,6.5303030303030303,6.6250000000000018,6.5124999999999993,6.1842105263157894,6.5068965517241368,6.4359999999999991,6.6000000000000005,6.3888888888888893,6.8285714285714283,6.5600000000000005,6.4874999999999989,6.681481481481482,6.6999999999999993,6.8723404255319176,6.8878787878787877,6.8000000000000007,6.8500000000000005,6.9222222222222207,6.7612903225806447,6.7605263157894742,6.7749999999999995,6.9298245614035086,6.6755555555555555,6.9265306122448962,6.7581818181818178,6.6555555555555577,6.6826666666666679,6.8536231884057992,6.9305555555555545,6.9220338983050835,6.7333333333333343,6.758208955223882,6.7203125000000012,6.5038461538461556,6.5825581395348811,6.4813725490196088,6.486516853932585,6.6492957746478867,6.4818181818181815,6.4625000000000012,6.5553846153846154,6.4411764705882337,6.7127906976744205,6.5341463414634156,6.590476190476191,6.3959999999999999,6.5215189873417732,6.6495145631067949,6.5987654320987668,6.664646464646462,6.2430232558139531,6.4947916666666687,6.460576923076923,6.3673469387755111,6.5193548387096767,6.5114285714285742,6.417272727272727,6.7138297872340438,6.4406779661016937,6.4990384615384613,6.1859375000000005,6.2865546218487376,6.2852713178294595,6.3037837837837829,6.2863414634146411,6.2243781094527328,6.2783673469387686,6.2760683760683778,6.167256637168145,6.3157377049180292,6.2473354231974936,6.1714285714285708,6.2479338842975203,6.2348780487804838,6.1822966507177055,6.1319612590799002,6.1329326923076941,6.2108843537414993,6.2313283208020032,6.2682038834951399,6.163488372093024,6.2331096196868039,6.3322033898305055,6.3104247104247113,6.3932754880694107,6.4259615384615403],"mode":"lines","type":"scatter","marker":{"color":"rgba(255,127,14,1)","line":{"color":"rgba(255,127,14,1)"}},"error_y":{"color":"rgba(255,127,14,1)"},"error_x":{"color":"rgba(255,127,14,1)"},"line":{"color":"rgba(255,127,14,1)"},"xaxis":"x","yaxis":"y","frame":null}],"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.20000000000000001,"selected":{"opacity":1},"debounce":0},"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot","plotly_sunburstclick"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}</script>
```


Так же как и в `ggplot2` при наложении слоев возможно наследование параметров. Например, в графике выше можно оставить только те параметры, которые определяют именно этот слой (значение по оси OY и название линии):

```r
plot_ly(imdb_genres_scores[genre == 'Horror'], x = ~year, y = ~votes,
        type = 'scatter', mode = 'lines') %>%
  add_trace(data = imdb_genres_scores[genre == 'Drama'])
```

```{=html}
<div class="plotly html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-cbb86a43819e1498f464" style="width:100%;height:480px;"></div>
<script type="application/json" data-for="htmlwidget-cbb86a43819e1498f464">{"x":{"visdat":{"9544776e1b2f8":["function () ","plotlyVisDat"],"954476ca8af83":["function () ","data"]},"cur_data":"954476ca8af83","attrs":{"9544776e1b2f8":{"x":{},"y":{},"mode":"lines","alpha_stroke":1,"sizes":[10,100],"spans":[1,20],"type":"scatter"},"954476ca8af83":{"x":{},"y":{},"mode":"lines","alpha_stroke":1,"sizes":[10,100],"spans":[1,20],"type":"scatter","inherit":true}},"layout":{"margin":{"b":40,"l":60,"t":25,"r":10},"xaxis":{"domain":[0,1],"automargin":true,"title":"year"},"yaxis":{"domain":[0,1],"automargin":true,"title":"votes"},"hovermode":"closest","showlegend":true},"source":"A","config":{"modeBarButtonsToAdd":["hoverclosest","hovercompare"],"showSendToCloud":false},"data":[{"x":[1915,1917,1920,1925,1927,1928,1932,1934,1935,1940,1941,1945,1946,1948,1949,1951,1952,1953,1957,1958,1959,1960,1961,1962,1963,1964,1965,1966,1967,1968,1969,1970,1971,1972,1973,1974,1975,1976,1977,1978,1979,1980,1981,1982,1983,1984,1985,1986,1987,1988,1989,1990,1991,1992,1993,1994,1995,1996,1997,1998,1999,2000,2001,2002,2003,2004,2005,2006,2007,2008,2009,2010,2011,2012,2013,2014,2015,2016,2017,2018,2019,2020],"y":[6.7999999999999998,6.0999999999999996,6,7.5999999999999996,6.7999999999999998,7.2999999999999998,6.2999999999999998,3.6500000000000004,7.0999999999999996,4.25,7.2999999999999998,6,4.8666666666666663,4.9499999999999993,7.0999999999999996,4.4000000000000004,5.5999999999999996,7.0999999999999996,5.0700000000000003,5.0499999999999998,5.8999999999999995,5.7222222222222223,5.0666666666666664,5.5444444444444452,5.8076923076923084,5.6352941176470601,4.6600000000000001,5.3769230769230756,5.0250000000000004,5.4699999999999998,4.96,5.0111111111111111,5.1552631578947361,4.8405405405405393,5.3414634146341466,4.8625000000000007,4.6315789473684212,5.1227272727272721,4.9650000000000007,4.9333333333333336,4.7428571428571429,5.0000000000000009,5.3533333333333326,4.8136363636363635,4.6739130434782616,4.3666666666666663,4.4285714285714288,4.3857142857142861,4.6424242424242426,4.418181818181818,4.6525000000000007,4.9208333333333334,4.9117647058823533,4.6533333333333333,4.7066666666666652,4.3599999999999994,4.0333333333333323,4.8181818181818183,4.4153846153846157,4.208333333333333,4.2750000000000004,3.9947368421052634,4.2923076923076922,4.7230769230769232,4.0473684210526315,3.9435897435897433,4.2166666666666668,4.0657142857142858,3.8637681159420283,4.1161290322580637,4.0424242424242438,4.0253521126760576,4.0236111111111104,3.9182926829268285,3.9614583333333346,4.1582524271844665,3.9165137614678875,3.9650485436893192,4.346564885496182,4.3315789473684205,4.1585106382978729,4.0628571428571432],"mode":"lines","type":"scatter","marker":{"color":"rgba(31,119,180,1)","line":{"color":"rgba(31,119,180,1)"}},"error_y":{"color":"rgba(31,119,180,1)"},"error_x":{"color":"rgba(31,119,180,1)"},"line":{"color":"rgba(31,119,180,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":[1911,1912,1913,1914,1915,1916,1917,1918,1919,1920,1921,1922,1923,1924,1925,1926,1927,1928,1929,1930,1931,1932,1933,1934,1935,1936,1937,1938,1939,1940,1941,1942,1943,1944,1945,1946,1947,1948,1949,1950,1951,1952,1953,1954,1955,1956,1957,1958,1959,1960,1961,1962,1963,1964,1965,1966,1967,1968,1969,1970,1971,1972,1973,1974,1975,1976,1977,1978,1979,1980,1981,1982,1983,1984,1985,1986,1987,1988,1989,1990,1991,1992,1993,1994,1995,1996,1997,1998,1999,2000,2001,2002,2003,2004,2005,2006,2007,2008,2009,2010,2011,2012,2013,2014,2015,2016,2017,2018,2019,2020],"y":[5.7999999999999998,5.5,6.7666666666666657,5.9000000000000004,6.327272727272728,6.2999999999999998,6.5800000000000001,6.1888888888888891,6.1600000000000001,6.1166666666666671,6.5764705882352947,6.4400000000000004,6.6624999999999996,6.6454545454545464,6.5294117647058814,6.8928571428571432,6.1999999999999993,6.4944444444444445,6.6099999999999994,6.477777777777777,6.2999999999999998,6.4857142857142875,6.4951219512195122,6.4840909090909102,6.5303030303030303,6.6250000000000018,6.5124999999999993,6.1842105263157894,6.5068965517241368,6.4359999999999991,6.6000000000000005,6.3888888888888893,6.8285714285714283,6.5600000000000005,6.4874999999999989,6.681481481481482,6.6999999999999993,6.8723404255319176,6.8878787878787877,6.8000000000000007,6.8500000000000005,6.9222222222222207,6.7612903225806447,6.7605263157894742,6.7749999999999995,6.9298245614035086,6.6755555555555555,6.9265306122448962,6.7581818181818178,6.6555555555555577,6.6826666666666679,6.8536231884057992,6.9305555555555545,6.9220338983050835,6.7333333333333343,6.758208955223882,6.7203125000000012,6.5038461538461556,6.5825581395348811,6.4813725490196088,6.486516853932585,6.6492957746478867,6.4818181818181815,6.4625000000000012,6.5553846153846154,6.4411764705882337,6.7127906976744205,6.5341463414634156,6.590476190476191,6.3959999999999999,6.5215189873417732,6.6495145631067949,6.5987654320987668,6.664646464646462,6.2430232558139531,6.4947916666666687,6.460576923076923,6.3673469387755111,6.5193548387096767,6.5114285714285742,6.417272727272727,6.7138297872340438,6.4406779661016937,6.4990384615384613,6.1859375000000005,6.2865546218487376,6.2852713178294595,6.3037837837837829,6.2863414634146411,6.2243781094527328,6.2783673469387686,6.2760683760683778,6.167256637168145,6.3157377049180292,6.2473354231974936,6.1714285714285708,6.2479338842975203,6.2348780487804838,6.1822966507177055,6.1319612590799002,6.1329326923076941,6.2108843537414993,6.2313283208020032,6.2682038834951399,6.163488372093024,6.2331096196868039,6.3322033898305055,6.3104247104247113,6.3932754880694107,6.4259615384615403],"mode":"lines","type":"scatter","marker":{"color":"rgba(255,127,14,1)","line":{"color":"rgba(255,127,14,1)"}},"error_y":{"color":"rgba(255,127,14,1)"},"error_x":{"color":"rgba(255,127,14,1)"},"line":{"color":"rgba(255,127,14,1)"},"xaxis":"x","yaxis":"y","frame":null}],"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.20000000000000001,"selected":{"opacity":1},"debounce":0},"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot","plotly_sunburstclick"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}</script>
```

<br>

## Общие параметры графиков {-}
Отдельный слой на графиках plotly - это слой общих параметров графика, таких как заголовок, тип группировки баров или боксплотов, параметры осей (заголовки, диапазоны, шрифты и проч), а так же отступы от краев графика. Все параметры задаются с помощью базовой функции layout(), которая первым аргументом принимает plotly-объект, а все прочие аргументы формируют параметры объекта. Рассмотрим параметры заголовка и осей, параметры легенд и группировки баров и боксплотов описаны в соответствующих разделах.

<br>

### Заголовок {-}
Заголовок на графиках формируется очень просто, с помощью аргумента `title` и, собственно, строки, которая должна быть заголовком графика. 

```r
plot_ly(rbind(imdb_woody, imdb_lynch), x = ~year, y = ~avg_vote,
        type = 'scatter', mode = 'markers', color = ~director) %>%
  layout(title = 'Woody + David')
```

```{=html}
<div class="plotly html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-d70ee5eadbd90823b8c4" style="width:100%;height:480px;"></div>
<script type="application/json" data-for="htmlwidget-d70ee5eadbd90823b8c4">{"x":{"visdat":{"95447521b6cdf":["function () ","plotlyVisDat"]},"cur_data":"95447521b6cdf","attrs":{"95447521b6cdf":{"x":{},"y":{},"mode":"markers","color":{},"alpha_stroke":1,"sizes":[10,100],"spans":[1,20],"type":"scatter"}},"layout":{"margin":{"b":40,"l":60,"t":25,"r":10},"title":"Woody + David","xaxis":{"domain":[0,1],"automargin":true,"title":"year"},"yaxis":{"domain":[0,1],"automargin":true,"title":"avg_vote"},"hovermode":"closest","showlegend":true},"source":"A","config":{"modeBarButtonsToAdd":["hoverclosest","hovercompare"],"showSendToCloud":false},"data":[{"x":[1977,1980,1984,1986,1990,1992,1997,1999,2001,2006,2014],"y":[7.4000000000000004,8.0999999999999996,6.5,7.7000000000000002,7.2000000000000002,7.2999999999999998,7.5999999999999996,8,8,6.9000000000000004,7.7000000000000002],"mode":"markers","type":"scatter","name":"David Lynch","marker":{"color":"rgba(102,194,165,1)","line":{"color":"rgba(102,194,165,1)"}},"textfont":{"color":"rgba(102,194,165,1)"},"error_y":{"color":"rgba(102,194,165,1)"},"error_x":{"color":"rgba(102,194,165,1)"},"line":{"color":"rgba(102,194,165,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":[1969,1971,1972,1973,1975,1977,1978,1979,1980,1982,1983,1984,1985,1986,1987,1987,1988,1989,1990,1992,1991,1993,1994,1995,1996,1997,1998,1999,2000,2001,2002,2003,2004,2005,2006,2008,2007,2009,2010,2011,2012,2013,2014,2015,2016,2017,2019],"y":[7.2999999999999998,7,6.7999999999999998,7.2000000000000002,7.7000000000000002,8,7.4000000000000004,7.9000000000000004,7.2999999999999998,6.5999999999999996,7.7000000000000002,7.4000000000000004,7.7000000000000002,7.9000000000000004,7.5,6.5,7.2999999999999998,7.9000000000000004,6.5999999999999996,7.5,6.7000000000000002,7.4000000000000004,7.4000000000000004,7,6.7000000000000002,7.4000000000000004,6.2999999999999998,7.2000000000000002,6.7000000000000002,6.7000000000000002,6.5999999999999996,6.2999999999999998,6.4000000000000004,7.5999999999999996,6.7000000000000002,7.0999999999999996,6.7000000000000002,7.0999999999999996,6.2999999999999998,7.7000000000000002,6.2999999999999998,7.2999999999999998,6.5,6.5999999999999996,6.5999999999999996,6.2000000000000002,6.5999999999999996],"mode":"markers","type":"scatter","name":"Woody Allen","marker":{"color":"rgba(141,160,203,1)","line":{"color":"rgba(141,160,203,1)"}},"textfont":{"color":"rgba(141,160,203,1)"},"error_y":{"color":"rgba(141,160,203,1)"},"error_x":{"color":"rgba(141,160,203,1)"},"line":{"color":"rgba(141,160,203,1)"},"xaxis":"x","yaxis":"y","frame":null}],"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.20000000000000001,"selected":{"opacity":1},"debounce":0},"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot","plotly_sunburstclick"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}</script>
```

Также, как и c некоторыми другими текстовыми метками на графиках plotly (ховеры, подписи осей, лейблы), в строке заголовка можно использовать html-теги:

```r
plot_ly(rbind(imdb_woody, imdb_lynch), x = ~year, y = ~avg_vote,
        type = 'scatter', mode = 'markers', color = ~director) %>%
  layout(title = 'Woody + David<br>используем тэг')
```

```{=html}
<div class="plotly html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-cce9181035662b59d685" style="width:100%;height:480px;"></div>
<script type="application/json" data-for="htmlwidget-cce9181035662b59d685">{"x":{"visdat":{"954473e569e9e":["function () ","plotlyVisDat"]},"cur_data":"954473e569e9e","attrs":{"954473e569e9e":{"x":{},"y":{},"mode":"markers","color":{},"alpha_stroke":1,"sizes":[10,100],"spans":[1,20],"type":"scatter"}},"layout":{"margin":{"b":40,"l":60,"t":25,"r":10},"title":"Woody + David<br>используем тэг","xaxis":{"domain":[0,1],"automargin":true,"title":"year"},"yaxis":{"domain":[0,1],"automargin":true,"title":"avg_vote"},"hovermode":"closest","showlegend":true},"source":"A","config":{"modeBarButtonsToAdd":["hoverclosest","hovercompare"],"showSendToCloud":false},"data":[{"x":[1977,1980,1984,1986,1990,1992,1997,1999,2001,2006,2014],"y":[7.4000000000000004,8.0999999999999996,6.5,7.7000000000000002,7.2000000000000002,7.2999999999999998,7.5999999999999996,8,8,6.9000000000000004,7.7000000000000002],"mode":"markers","type":"scatter","name":"David Lynch","marker":{"color":"rgba(102,194,165,1)","line":{"color":"rgba(102,194,165,1)"}},"textfont":{"color":"rgba(102,194,165,1)"},"error_y":{"color":"rgba(102,194,165,1)"},"error_x":{"color":"rgba(102,194,165,1)"},"line":{"color":"rgba(102,194,165,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":[1969,1971,1972,1973,1975,1977,1978,1979,1980,1982,1983,1984,1985,1986,1987,1987,1988,1989,1990,1992,1991,1993,1994,1995,1996,1997,1998,1999,2000,2001,2002,2003,2004,2005,2006,2008,2007,2009,2010,2011,2012,2013,2014,2015,2016,2017,2019],"y":[7.2999999999999998,7,6.7999999999999998,7.2000000000000002,7.7000000000000002,8,7.4000000000000004,7.9000000000000004,7.2999999999999998,6.5999999999999996,7.7000000000000002,7.4000000000000004,7.7000000000000002,7.9000000000000004,7.5,6.5,7.2999999999999998,7.9000000000000004,6.5999999999999996,7.5,6.7000000000000002,7.4000000000000004,7.4000000000000004,7,6.7000000000000002,7.4000000000000004,6.2999999999999998,7.2000000000000002,6.7000000000000002,6.7000000000000002,6.5999999999999996,6.2999999999999998,6.4000000000000004,7.5999999999999996,6.7000000000000002,7.0999999999999996,6.7000000000000002,7.0999999999999996,6.2999999999999998,7.7000000000000002,6.2999999999999998,7.2999999999999998,6.5,6.5999999999999996,6.5999999999999996,6.2000000000000002,6.5999999999999996],"mode":"markers","type":"scatter","name":"Woody Allen","marker":{"color":"rgba(141,160,203,1)","line":{"color":"rgba(141,160,203,1)"}},"textfont":{"color":"rgba(141,160,203,1)"},"error_y":{"color":"rgba(141,160,203,1)"},"error_x":{"color":"rgba(141,160,203,1)"},"line":{"color":"rgba(141,160,203,1)"},"xaxis":"x","yaxis":"y","frame":null}],"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.20000000000000001,"selected":{"opacity":1},"debounce":0},"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot","plotly_sunburstclick"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}</script>
```

<br>

### Параметры осей {-}
Из параметров осей самые важные - это название оси (особенно важно при отрисовке совмещенных графиков), а так же диапазоны, которые должны быть отражены. Особенно это важно для оси OY, так как по умолчанию на линейных графиках ось начинается на с нуля, а с минимального значения, что несколько противоречит общепринятым нормам в визуализации данных.

Параметры осей также задаются списками параметров. Название оси задается через параметр `title`, а диапазоны можно указать либо вектором с границами диапазона и параметром `range`. Параметр `rangemode` со значением `tozero` указывает что ось необходимо строить от нуля (можно также указать `nonnegative`, все неотрицательные). 

```r
plot_ly(rbind(imdb_woody, imdb_lynch), x = ~year, y = ~avg_vote,
        type = 'scatter', mode = 'markers', color = ~director) %>%
  layout(title = 'Woody + David',
         xaxis = list(title = ''),
         yaxis = list(rangemode = 'tozero'))
```

```{=html}
<div class="plotly html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-d640bdbd9951be5a180a" style="width:100%;height:480px;"></div>
<script type="application/json" data-for="htmlwidget-d640bdbd9951be5a180a">{"x":{"visdat":{"954477ce13b4f":["function () ","plotlyVisDat"]},"cur_data":"954477ce13b4f","attrs":{"954477ce13b4f":{"x":{},"y":{},"mode":"markers","color":{},"alpha_stroke":1,"sizes":[10,100],"spans":[1,20],"type":"scatter"}},"layout":{"margin":{"b":40,"l":60,"t":25,"r":10},"title":"Woody + David","xaxis":{"domain":[0,1],"automargin":true,"title":""},"yaxis":{"domain":[0,1],"automargin":true,"rangemode":"tozero","title":"avg_vote"},"hovermode":"closest","showlegend":true},"source":"A","config":{"modeBarButtonsToAdd":["hoverclosest","hovercompare"],"showSendToCloud":false},"data":[{"x":[1977,1980,1984,1986,1990,1992,1997,1999,2001,2006,2014],"y":[7.4000000000000004,8.0999999999999996,6.5,7.7000000000000002,7.2000000000000002,7.2999999999999998,7.5999999999999996,8,8,6.9000000000000004,7.7000000000000002],"mode":"markers","type":"scatter","name":"David Lynch","marker":{"color":"rgba(102,194,165,1)","line":{"color":"rgba(102,194,165,1)"}},"textfont":{"color":"rgba(102,194,165,1)"},"error_y":{"color":"rgba(102,194,165,1)"},"error_x":{"color":"rgba(102,194,165,1)"},"line":{"color":"rgba(102,194,165,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":[1969,1971,1972,1973,1975,1977,1978,1979,1980,1982,1983,1984,1985,1986,1987,1987,1988,1989,1990,1992,1991,1993,1994,1995,1996,1997,1998,1999,2000,2001,2002,2003,2004,2005,2006,2008,2007,2009,2010,2011,2012,2013,2014,2015,2016,2017,2019],"y":[7.2999999999999998,7,6.7999999999999998,7.2000000000000002,7.7000000000000002,8,7.4000000000000004,7.9000000000000004,7.2999999999999998,6.5999999999999996,7.7000000000000002,7.4000000000000004,7.7000000000000002,7.9000000000000004,7.5,6.5,7.2999999999999998,7.9000000000000004,6.5999999999999996,7.5,6.7000000000000002,7.4000000000000004,7.4000000000000004,7,6.7000000000000002,7.4000000000000004,6.2999999999999998,7.2000000000000002,6.7000000000000002,6.7000000000000002,6.5999999999999996,6.2999999999999998,6.4000000000000004,7.5999999999999996,6.7000000000000002,7.0999999999999996,6.7000000000000002,7.0999999999999996,6.2999999999999998,7.7000000000000002,6.2999999999999998,7.2999999999999998,6.5,6.5999999999999996,6.5999999999999996,6.2000000000000002,6.5999999999999996],"mode":"markers","type":"scatter","name":"Woody Allen","marker":{"color":"rgba(141,160,203,1)","line":{"color":"rgba(141,160,203,1)"}},"textfont":{"color":"rgba(141,160,203,1)"},"error_y":{"color":"rgba(141,160,203,1)"},"error_x":{"color":"rgba(141,160,203,1)"},"line":{"color":"rgba(141,160,203,1)"},"xaxis":"x","yaxis":"y","frame":null}],"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.20000000000000001,"selected":{"opacity":1},"debounce":0},"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot","plotly_sunburstclick"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}</script>
```

В параметрах осей также можно задавать параметры названия оси, меток (шрифт, наклон, количество и шаг меток), цвет и ширину линий осей и координатной сетки, а так же отдельные параметры для определенных типов графиков. Все это достаточно редкие в использовании кейсы, и все следуют общей логике - параметры элемента задаются списком параметров, некоторые из которых имеют ограниченный набор значений. Подробнее в [документации](https://plot.ly/r/reference/#layout) по функции `layout()`.

<br>

## Совмещенные графики {-}
Одна из самых частых задач, котрые возникают при работе с `plotly`, это совмещение нескольких графиков на одном общем графике. В ggplot2 это аналог фасет.

Для совмещения графиков используется функция `subplot()`, в которую первыми аргументами передаются `plot_ly`-объекты (графики). Для указания, вертикально или горизонтально компоновать графики, аргумент nrows. По умолчанию он равен единице, то есть графики компонуются в ряд по горизонтали, противном же случае идет компоновка по вертикали. Если же графиков больше, чем заданных строк, то сначала графики компонуются построчно так, чтобы на последней указанной строке был хотя бы один график. Также в функции `subplot()` есть еще ряд аргументов, которые задают соотношение графиков между собой - каково должно быть расстояние, будут ли объеденены подписи осей и т.д. На практике, впрочем, эти параметры используются нечасто.

Пример совмещения графиков - показываем информацию по двум режиссерам на двух отдельных графиках, а не на одном. Параметр `nrows` задает, в сколько строк должны быть организованы графики, если параметр не указан, то графики компонуются вертикально, на одной линии:

```r
subplot(
  plot_ly(imdb_woody, x = ~year, y = ~avg_vote,
        type = 'scatter', mode = 'lines'),
    plot_ly(imdb_lynch, x = ~year, y = ~avg_vote,
        type = 'scatter', mode = 'lines'),
  nrows = 2)
```

```{=html}
<div class="plotly html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-8bb2a798c7f0b9166481" style="width:100%;height:480px;"></div>
<script type="application/json" data-for="htmlwidget-8bb2a798c7f0b9166481">{"x":{"data":[{"x":[1969,1971,1972,1973,1975,1977,1978,1979,1980,1982,1983,1984,1985,1986,1987,1987,1988,1989,1990,1992,1991,1993,1994,1995,1996,1997,1998,1999,2000,2001,2002,2003,2004,2005,2006,2008,2007,2009,2010,2011,2012,2013,2014,2015,2016,2017,2019],"y":[7.2999999999999998,7,6.7999999999999998,7.2000000000000002,7.7000000000000002,8,7.4000000000000004,7.9000000000000004,7.2999999999999998,6.5999999999999996,7.7000000000000002,7.4000000000000004,7.7000000000000002,7.9000000000000004,7.5,6.5,7.2999999999999998,7.9000000000000004,6.5999999999999996,7.5,6.7000000000000002,7.4000000000000004,7.4000000000000004,7,6.7000000000000002,7.4000000000000004,6.2999999999999998,7.2000000000000002,6.7000000000000002,6.7000000000000002,6.5999999999999996,6.2999999999999998,6.4000000000000004,7.5999999999999996,6.7000000000000002,7.0999999999999996,6.7000000000000002,7.0999999999999996,6.2999999999999998,7.7000000000000002,6.2999999999999998,7.2999999999999998,6.5,6.5999999999999996,6.5999999999999996,6.2000000000000002,6.5999999999999996],"mode":"lines","type":"scatter","marker":{"color":"rgba(31,119,180,1)","line":{"color":"rgba(31,119,180,1)"}},"error_y":{"color":"rgba(31,119,180,1)"},"error_x":{"color":"rgba(31,119,180,1)"},"line":{"color":"rgba(31,119,180,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":[1977,1980,1984,1986,1990,1992,1997,1999,2001,2006,2014],"y":[7.4000000000000004,8.0999999999999996,6.5,7.7000000000000002,7.2000000000000002,7.2999999999999998,7.5999999999999996,8,8,6.9000000000000004,7.7000000000000002],"mode":"lines","type":"scatter","marker":{"color":"rgba(255,127,14,1)","line":{"color":"rgba(255,127,14,1)"}},"error_y":{"color":"rgba(255,127,14,1)"},"error_x":{"color":"rgba(255,127,14,1)"},"line":{"color":"rgba(255,127,14,1)"},"xaxis":"x2","yaxis":"y2","frame":null}],"layout":{"xaxis":{"domain":[0,1],"automargin":true,"anchor":"y"},"xaxis2":{"domain":[0,1],"automargin":true,"anchor":"y2"},"yaxis2":{"domain":[0,0.47999999999999998],"automargin":true,"anchor":"x2"},"yaxis":{"domain":[0.52000000000000002,1],"automargin":true,"anchor":"x"},"annotations":[],"shapes":[],"images":[],"margin":{"b":40,"l":60,"t":25,"r":10},"hovermode":"closest","showlegend":true},"attrs":{"9544772c43fa1":{"x":{},"y":{},"mode":"lines","alpha_stroke":1,"sizes":[10,100],"spans":[1,20],"type":"scatter"},"954476d1a235b":{"x":{},"y":{},"mode":"lines","alpha_stroke":1,"sizes":[10,100],"spans":[1,20],"type":"scatter"}},"source":"A","config":{"modeBarButtonsToAdd":["hoverclosest","hovercompare"],"showSendToCloud":false},"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.20000000000000001,"selected":{"opacity":1},"debounce":0},"subplot":true,"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot","plotly_sunburstclick"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}</script>
```

Задать название графика, названия и параметры осей можно также с помощью функции `layout()`, которая определяет параметры всего графика. Как и в прочих наших графиках, зададим название и укажем, что оси OY начинаются от нуля. Так как на графике несколько осей OX и OY, для их определения используется численный индекс, yaxis (или yaxis1), yaxis2, yaxis3 и т.д., по порядку вызова объектов в `subplot()`.


```r
subplot(
  plot_ly(imdb_woody, x = ~year, y = ~avg_vote,
        type = 'scatter', mode = 'lines'),
    plot_ly(imdb_lynch, x = ~year, y = ~avg_vote,
        type = 'scatter', mode = 'lines'),
  nrows = 2) %>%
  layout(title = 'Woody + Lynch',
         xaxis = list(title = ''),
         showlegend = FALSE,
         yaxis = list(title = 'Woody Allen', rangemode = 'tozero'),
         yaxis2 = list(title = 'David Lynch', rangemode = 'tozero'))
```

```{=html}
<div class="plotly html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-cc9275a77eb5cbe28313" style="width:100%;height:480px;"></div>
<script type="application/json" data-for="htmlwidget-cc9275a77eb5cbe28313">{"x":{"data":[{"x":[1969,1971,1972,1973,1975,1977,1978,1979,1980,1982,1983,1984,1985,1986,1987,1987,1988,1989,1990,1992,1991,1993,1994,1995,1996,1997,1998,1999,2000,2001,2002,2003,2004,2005,2006,2008,2007,2009,2010,2011,2012,2013,2014,2015,2016,2017,2019],"y":[7.2999999999999998,7,6.7999999999999998,7.2000000000000002,7.7000000000000002,8,7.4000000000000004,7.9000000000000004,7.2999999999999998,6.5999999999999996,7.7000000000000002,7.4000000000000004,7.7000000000000002,7.9000000000000004,7.5,6.5,7.2999999999999998,7.9000000000000004,6.5999999999999996,7.5,6.7000000000000002,7.4000000000000004,7.4000000000000004,7,6.7000000000000002,7.4000000000000004,6.2999999999999998,7.2000000000000002,6.7000000000000002,6.7000000000000002,6.5999999999999996,6.2999999999999998,6.4000000000000004,7.5999999999999996,6.7000000000000002,7.0999999999999996,6.7000000000000002,7.0999999999999996,6.2999999999999998,7.7000000000000002,6.2999999999999998,7.2999999999999998,6.5,6.5999999999999996,6.5999999999999996,6.2000000000000002,6.5999999999999996],"mode":"lines","type":"scatter","marker":{"color":"rgba(31,119,180,1)","line":{"color":"rgba(31,119,180,1)"}},"error_y":{"color":"rgba(31,119,180,1)"},"error_x":{"color":"rgba(31,119,180,1)"},"line":{"color":"rgba(31,119,180,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":[1977,1980,1984,1986,1990,1992,1997,1999,2001,2006,2014],"y":[7.4000000000000004,8.0999999999999996,6.5,7.7000000000000002,7.2000000000000002,7.2999999999999998,7.5999999999999996,8,8,6.9000000000000004,7.7000000000000002],"mode":"lines","type":"scatter","marker":{"color":"rgba(255,127,14,1)","line":{"color":"rgba(255,127,14,1)"}},"error_y":{"color":"rgba(255,127,14,1)"},"error_x":{"color":"rgba(255,127,14,1)"},"line":{"color":"rgba(255,127,14,1)"},"xaxis":"x2","yaxis":"y2","frame":null}],"layout":{"xaxis":{"domain":[0,1],"automargin":true,"anchor":"y","title":""},"xaxis2":{"domain":[0,1],"automargin":true,"anchor":"y2"},"yaxis2":{"domain":[0,0.47999999999999998],"automargin":true,"anchor":"x2","title":"David Lynch","rangemode":"tozero"},"yaxis":{"domain":[0.52000000000000002,1],"automargin":true,"anchor":"x","title":"Woody Allen","rangemode":"tozero"},"annotations":[],"shapes":[],"images":[],"margin":{"b":40,"l":60,"t":25,"r":10},"hovermode":"closest","showlegend":false,"title":"Woody + Lynch"},"attrs":{"9544774ca3f1":{"x":{},"y":{},"mode":"lines","alpha_stroke":1,"sizes":[10,100],"spans":[1,20],"type":"scatter"},"95447273ee4ab":{"x":{},"y":{},"mode":"lines","alpha_stroke":1,"sizes":[10,100],"spans":[1,20],"type":"scatter"}},"source":"A","config":{"modeBarButtonsToAdd":["hoverclosest","hovercompare"],"showSendToCloud":false},"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.20000000000000001,"selected":{"opacity":1},"debounce":0},"subplot":true,"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot","plotly_sunburstclick"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}</script>
```

<!-- ## Домашняя работа -->

<!-- ### level 1 (IATYTD) {-} -->
<!-- С помощью пакета `plotly` отрисуйте график рассеяния, отражающий связь таких параметров, как `carat` и `price`. Используйте датасет ggplot2::diamonds, сделайте сабсет на 10000 строк (используйте `set.seed(1234)` для генерации зерна генератора случайных цифр). Удалите строки, в которых `carat > 3` -->

<!-- ```{r 10-visualization-19, message=FALSE, echo=FALSE} -->
<!-- library(ggplot2) -->
<!-- library(plotly) -->
<!-- library(data.table) -->

<!-- set.seed(1234) -->
<!-- # base R -->
<!-- # diamonds_sample <- diamonds[sample(nrow(diamonds), 1000), ] -->
<!-- # diamonds_sample <- diamonds_sample[diamonds_sample$carat <= 3, ] -->

<!-- # data.table -->
<!-- diamonds_sample <- as.data.table(diamonds) -->
<!-- diamonds_sample <- diamonds_sample[sample(.N, 1000)] -->
<!-- diamonds_sample <- diamonds_sample[carat <= 3] -->


<!-- plot_ly(diamonds_sample, x = ~carat, y = ~price, type = 'scatter', mode = 'markers') -->
<!-- ``` -->

<!-- ### level 2 (HNTR) {-} -->

<!-- Повторите предыдущий график, добавьте выделение цветом бриллиантов разного качества (`cut`) -->

<!-- ```{r 10-visualization-20, echo = FALSE} -->
<!-- plot_ly(diamonds_sample, x = ~carat, y = ~price, color = ~cut, type = 'scatter', mode = 'markers') -->
<!-- ``` -->

<!-- ### level 3 (HMP) {-} -->

<!-- Наложите с помощью функций `fitted()` и `loess()` линию тренда, демонстрирующую взаимосвязь размера камня и его цены (`price ~ carat`). -->


<!-- ### Level 4: Ultra-violence {-} -->

<!-- Полученную линию тренда сделайте красной, размера 4 и пунктирной. Линию в легенде назовите как `loess trend`. Подпишите график задания и оси. В заголовке графика сделайте перенос строки. -->

<!-- ```{r 10-visualization-26, echo = FALSE} -->
<!-- plot_ly(diamonds_sample, x = ~carat, y = ~price, color = ~cut,  -->
<!--         type = 'scatter', mode = 'markers') %>% -->
<!--   add_lines(data = diamonds_sample, x = ~carat, y = ~fitted((loess(price ~ carat))), -->
<!--             inherit = FALSE, name = 'loess trend',  -->
<!--             line = list(color = 'red', width = 4, dash = "dash")) %>% -->
<!--   layout( -->
<!--     title = 'Взаимосвязь стоимости бриллиантов и их размера<br> + loess-линия тренда', -->
<!--     xaxis = list(title = 'размер в каратах'), -->
<!--     yaxis = list(title = 'стоимость в у.е.') -->
<!--   ) -->
<!-- ``` -->

<!-- ### Level 5: Nightmare {-} -->
<!-- Измените на графике информацию, которая дается в ховере (hover), сделайте более понятными обозначения и округлите значения до сотен, а также добавьте информацию о качестве огранки и чистоте камня. Пример ховера: "carat = 3, price = 8k, cut = Fair, clarity = I1", каждый параметр камня с новой строки. Для линии тренда менять ховер не нужно. -->

<!-- ```{r 10-visualization-32, echo = FALSE} -->
<!-- # data.frame -->
<!-- # diamonds_sample$var_hover <-  -->
<!-- #   paste0('carat = ', diamonds_sample$carat, '<br>', -->
<!-- #          'price = ' , round(diamonds_sample$price, -3), 'k<br>', -->
<!-- #          'cut = ', diamonds_sample$cut, '<br>', -->
<!-- #          'clarity = ', diamonds_sample$clarity)] -->


<!-- # data.table  -->
<!-- setDT(diamonds_sample) -->
<!-- diamonds_sample[, var_hover := paste0('carat = ', carat, '<br>',  -->
<!--                              'price = ' , round(price, -3), 'k<br>', -->
<!--                              'cut = ', cut, '<br>', -->
<!--                              'clarity = ', clarity)] -->

<!-- plot_ly(diamonds_sample, x = ~carat, y = ~price, color = ~cut,  -->
<!--         type = 'scatter', mode = 'markers', -->
<!--         text = ~var_hover, hoverinfo = 'text') %>% -->
<!--   add_lines(data = diamonds_sample, x = ~carat, y = ~fitted((loess(price ~ carat))), -->
<!--             inherit = FALSE, name = 'loess trend',  -->
<!--             line = list(color = 'red', width = 4, dash = "dash")) %>% -->
<!--   layout( -->
<!--     title = 'Взаимосвязь стоимости бриллиантов и их размера<br> + loess-линия тренда', -->
<!--     xaxis = list(title = 'размер в каратах'), -->
<!--     yaxis = list(title = 'стоимость в у.е.') -->
<!--   ) -->
<!-- ``` -->
